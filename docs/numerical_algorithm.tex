% !TEX program = pdflatex

\documentclass[11pt]{article}
\usepackage{amsmath,amsfonts,amsthm,amssymb,geometry,dsfont}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage[
bookmarks=false,
pdfstartview={FitV},
pdftitle={Equilibrium Technology Diffusion, Trade, and Growth: Computational Appendix},
pdfauthor={Jesse Perla, Christopher Tonetti, Michael E. Waugh},
pdfcreator={Jesse Perla, Christopher Tonetti, Michael E. Waugh},
pdfkeywords={economics,international,growth,technology diffusion, trade, Perla, Tonetti, Waugh},
colorlinks=true,
linkcolor=darkgray,
citecolor=darkgray,
urlcolor=darkgray,
filecolor=darkgray,
anchorcolor=darkgray, 
breaklinks]
{hyperref}
\usepackage[capitalise,noabbrev]{cleveref} %
\crefname{equation}{}{} %
\crefname{assumption}{Assumption}{Assumptions}	
\crefname{property}{Property}{Properties}	
\geometry{left=1in,right=1in,top=0.6in,bottom=1in}

\newcommand{\D}[1][]{\ensuremath{\boldsymbol{\partial}_{#1}}}
\newcommand{\R}{\ensuremath{\mathbb{R}}}
\newcommand{\diff}{\ensuremath{\mathrm{d}}}
\newcommand{\set}[1]{\ensuremath{\left\{{#1}\right\}}}
\newcommand{\indicator}[1]{\ensuremath{\mathds{1}\left\{{#1}\right\}}}
\newcommand{\condexpec}[3][]{\ensuremath{\mathbb{E}_{#1}\left[{#2} \; \middle| \; {#3} \right]}}
\newcommand{\expec}[2][]{\ensuremath{\mathbb{E}_{{#1}}\left[ {#2} \right]}}
\begin{document}
\title{Equilibrium Technology Diffusion, Trade, and Growth\\Online Computational Appendix\thanks{Thanks...}}
\author{Jesse Perla \and Christopher Tonetti \and Michael E. Waugh}
\maketitle

\section{Simplified Growth Model with Transition Dynamics}
We start with an artificially simple version of the model with transition dynamics, which is nested in BPT2.  In the PTW case, $\pi(z,t), r(t), x(t)$ will come from calculations, but the basic structure is otherwise the same.

A key simplification maintained in the both this simple and the full PTW transition dynamics: in the transition dynamics experiments we are looking at, the normalized distribution $F(z)$ will remain constant over all time.  Hence, we do not need to jointly solve the KFE as we will be at the stationary level (post-normalization).  This is a major simplification for the transition dynamics case compared to many heterogeneous agent models.  %In particular, we will only look at examples where $F(z) = 1 - e^{-\theta z}$ for all $t$.

\subsection{Summary of Equations}
Let $Z$ be productivity, where $Z(t) \geq M(t)$.  Let $V(Z,t)$ is the value function prior to normalization, $M(t)$ the endogenous threshold, $\Pi(Z,t)$ the profits, and $X(t)$ the adoption cost.  Then define the normalization that $z \equiv \log(Z/M(t))$, $v(z,t) \equiv \frac{e^{-z}}{M(t)}V(M(t)e^z, t))$, $\pi(z,t) \equiv \frac{e^{-z}}{M(t)}\Pi(M(t)e^z, t))$, and $x(t) \equiv X(t)/M(t)$.  \cref{sec:simple-derivation} show the rescaled system of equation is
\begin{align}
\D[t]v(z,t) &= A(t)v(z,t) - \pi(z,t)\label{eq:simple-summary1}\\
v(0,t) &= \int_{0}^{\infty}  v(z,t) \left(e^z F'(z)\right) \diff z - x(t)\label{eq:simple-summary2}\\
\D[z]v(0,t) + v(0,t) &= 0\label{eq:simple-summary3}\\
\intertext{Where,}
A(t) &\equiv \left(r - \mu - \frac{\upsilon^2}{2}\right) - (\mu+ \upsilon^2 - g(t)) \D[z] - \frac{\upsilon^2}{2} \D[zz]\label{eq:simple-summary4}
\end{align} 

\subsection{Steady State}
For the exogenous $\pi(z,t)$ and $x(t)$ we require that at some $T$ it becomes stationary and
\begin{align}
x(t) &= \zeta,\quad \text{ for all }t \geq T\label{eq:terminal-x}\\
\pi(z,t) &= 1,\quad \text{ for all }t \geq T\label{eq:terminal-pi}\\
f(z,t) &= \theta e^{-\theta z},\quad \text{ for all }t \label{eq:f-stationary-summary}
\end{align}

\noindent With this, BPT2 gives us that,

\begin{align}
g \equiv g(T) &= 	\mu+ \frac{1-(\theta -1) \zeta  \left(r-\mu\right)}{(\theta -1)^2 \zeta }+ \frac{\upsilon^2}{2}\frac{\theta  \left(\theta(\theta -1)    \left(r-\mu-\frac{\upsilon ^2}{2}\right) \zeta-2\right)+1}{(\theta -1) \left((\theta -1)   \left(r-\mu-\frac{\upsilon ^2}{2}\right)\zeta-1\right)}. \label{eq:g-gbm}\\
v(z,T) &= \frac1{r-\mu- \upsilon^2/2}\left(1 + \frac1{\nu} e^{-(\nu + 1) z}\right)\label{eq:v-gbm-sol},
\intertext{where,}
\nu &\equiv  \frac{\mu- g}{\upsilon^2} + \sqrt{\left(\frac{g-\mu}{\upsilon^2} \right)^{2} + \frac{r-g}{\upsilon^2/2}}. \label{eq:nu-gbm}
\end{align}

Note: since $v(z,T)$ has been rescaled by $e^{-z}$ above, it is now a \textbf{decreasing} function for at least some of $z$.

\subsection{Spatial Discretization}

In this subsection we apply a discretization operator and ensure the boundary conditions are fulfilled.

Define a  grid $\set{z_i}_{i=1}^I$ with $z_1 = 0$ and $z_I = \bar{z}$ is a ``large'' number (keeping in mind that the effective number is $e^{\bar{z}}$).  After discretizing, we will denote the grid with the variable name, i.e. $z \equiv \set{z_i}_{i=1}^I$.  Given the exogenous $\pi(z,t)$ functions, the discretized equivalents is $\pi(t) \in \R^I$.

Assume upwind finite difference discretization of the differential operators subject to the homogenous boundary values, such that \cref{eq:new-BC1,eq:new-BC2} hold, which creates $L^{-}_1$ and $L_2$ from \cref{sec:discretization-operators}.\footnote{Here, we will check that $(\mu+ \sigma^2 - g(t)) < 0$ so that $L^{-}_1$ is backwards differences, and consequently the correct upwind direction.}  The discretization of $A(t)$ subject to the boundary conditions is then (in the interior)
\begin{align}
A(t) &\equiv \left(r - \mu - \frac{\upsilon^2}{2}\right) I - (\mu + \upsilon^2 - g(t)) L^{-}_1 - \frac{\upsilon^2}{2} L_2\label{eq:A-def-simple}
\end{align}
and the PDE in \cref{eq:simple-summary1} becomes the system of ODEs
\begin{align}
	v'(t) &= A(t) v(t) - \pi(t)\label{eq:discretized-simple}\\
	\intertext{Let $v_1(t)$ be the $1$st element in the $v(t)$ vector, corresponding to $v(0,t)$.  Then, the value matching condition is}
	v_1(t) &= \omega \cdot v(t) - x(t)\label{eq:discretized-simple-vm}\\
	\intertext{Where,}
	\omega_i &\equiv \bar{\omega} \frac{\theta e^{(1 - \theta)z_i}}{1 - e^{-\theta \bar{z}}}
	\intertext{And the weights for the non-uniform trapezoidal rule is calculated with the $\Delta_{-}$ and $\Delta_{+}$ backwards and forward diffs (respectively) for the $z$ grid (with $\Delta_{1,-} = 0$ and $\Delta_{I,+} = 0$ set for the ghost nodes),}
\bar{\omega}&\equiv \frac1{2}(\Delta_{-} + \Delta_{+})
\end{align}

Where the $\omega$ come from \cref{sec:quadrature} and combines quadrature nodes with $e^z$ and the $F'(z)$, and $\bar{\omega}$ are the irregular Simpson's rule weights.

To find the stationary solution at $T$, solve the system of equations $A(T) v(T) = \pi(T)$ and $v_1(T) = \omega \cdot v(T) - x(T)$ for the $v(T)$ and $g$ with a nonlinear solver.\footnote{Or by fixing a $g$, solving the linear \cref{eq:discretized-simple} and then picking the $g$ to equate \cref{eq:discretized-simple-vm} }  You can also compare to the analytic solution in \cref{eq:simple-summary1}.

\section{Full Growth Model with Transition Dynamics}
Assume $\delta > 0$.  This trade liberalization experiment will involve a one-time unanticipated decrease in $d$ as the trade liberalization.  We will calculate the two steady states and examine the transition dynamics.

In order to solve the dynamic problem in, we need to calculate $\tilde{\rho}(t), \pi_{\min}(t),\hat{z}(t),$ etc  as a function of $g(t), \Omega(t),$ and parameters.  As a simplification, we will assume that the cost of adoption is in labor, i.e. $\eta = 0$, so that $x(t) = \zeta$ for all $t$ from (PTW H.11)\footnote{Otherwise, there is an addition system of implicit equations to solve.}  %We also assume $\log$ utility, so that $\gamma = 1$.

\subsection{Number of Varieties and Entry in Transition}

Define $E(t)$ such that the \textbf{gross} entry flow is $E(t)\Omega(t)$.  Since the \textbf{gross} exit flow is $\delta \Omega(t)$, then the differential equation for $\Omega(t)$ comes from the net flows,
\begin{align}
	\D[t] \Omega(t) &= \left(E(t) - \delta \right)\Omega(t)\\
\intertext{Rearrange,}
E(t) &\equiv \delta + \D[t]\log \Omega(t)
\end{align}	
Therefore, in the steady-state we must have $E(t) = \delta$.

\subsection{Differential Equations}\label{sec:full-ODE}
The dynamic set of differential equations (rescaled) is derived in \cref{sec:full-model-derivations}.
\begin{align}
%	\tilde{\rho}(t) v(z,t) &= \pi(z,t) + (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z]v(z,t) + \frac{\upsilon^2}{2}\D[zz]v(z,t) + \D[t]v(z,t)\\
%	\D[t]v(z,t) &= \left(\tilde{\rho}(t)  - (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z] - \frac{\upsilon^2}{2}\D[zz]\right)v(z,t) - \pi(z,t) \\	
	\D[t]v(z,t) &= A(t)v(z,t) - \pi(z,t) \\	
	A(t) &\equiv \tilde{\rho}(t)  - (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z] - \frac{\upsilon^2}{2}\D[zz]\\
	v(0,t) &= \int_{0}^{\bar{z}}v(z,t) \frac{e^{\sigma - 1}F'(z)}{F(\bar{z})} \diff z - \zeta\\
	0 &= (\sigma - 1)v(0,t) + \D[z]v(0,t)\\
	0 &= (\sigma - 1)v(\bar{z},t) + \D[z]v(\bar{z},t)
\end{align}




\subsection{Dynamic Equations and Discretization}
To discretize \cref{sec:full-ODE}, define the interior operator, in a way similar to \cref{eq:A-def-simple}
\begin{align}
	A(t) &\equiv \tilde{\rho}(t) I - (\mu - g(t) + (\sigma - 1)\upsilon^2) L^{-}_1 - \frac{\upsilon^2}{2} L_2\label{eq:A-def-full}
	\end{align}
Discretize this and implement the boundary conditions in the discretized operator, as before, to get the system of ODEs,
\begin{align}
	v'(t) &= A(t) v(t) - \pi(t)
\end{align}	

The three variables required in the DAE are $g(t), \hat{z}(t),$ and $\Omega(t)$.\footnote{Note: the $\hat{z}(t)$ \textbf{has no log} taken of it, unlike the $z$.  Hence, to see if a firm exports, we need to check if $z \geq \log(\hat{z}(t))$.  Furthermore, it means that the $\hat{z}$ has a minimum value of $1$.}  The \cref{eq:normalized-vm-summary-rescaled} value matching equation uses the same discretization approach as in the simple example (combining everything into the weights $\omega$, with the truncated exponential distribution, etc.) to discretize as
\begin{align}
	0 &= v_1(t) - \omega \cdot v(t) + \zeta
\end{align}

The export threshold equation is
\begin{align}
	0&=\hat{z}^{\sigma-1}-  \kappa d^{\sigma - 1} \bar{\pi}_{\min}(t)^{-1}
\end{align}

From \cref{sec:free-entry}, we see that
\begin{align}
	v_1(t) &\leq \zeta \frac{1-\chi}{\chi},\, = \text{ if } E(t) > 0
\end{align}


\subsection{Static Calculations and Definitions}
Given the current $g$ and $\hat{z}$, the following definitions calculated at every time period, in the following rough order within the function.\footnote{See \cref{sec:derive-interest-rates} for a derivation of the interest rates, \cref{sec:full-rescaling} for a derivation of the normalized profits, and (PTW.H.2, H.7, H.8, )}.
\begin{align}
	S(t) &\equiv \theta \left( g(t) - \mu - \frac{\upsilon^2}{2}\right)\\
	1 - \tilde{L}(t) &\equiv 1 - \Omega(t)\left((N -1)\hat{z}^{-\theta}\kappa + \zeta \left(S(t) + E(t)/\chi \right)\right)\\
	\bar{z}(t)^{\sigma - 1}&\equiv \Omega(t)
\frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{1-\sigma}\hat{z}^{\sigma - 1 -\theta} \right)\\
	\bar{\pi}_{\min}(t) &\equiv \frac{1-\tilde{L}(t)}{(\sigma-1)\bar{z}(t)^{\sigma-1}}\\
	\pi(z,t) &\equiv \bar{\pi}_{\min}(t)\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa e^{-(\sigma - 1)z}\indicator{z \geq \log(\hat{z}(t))}\\
	\tilde{\rho}(t) &\equiv \rho+ \delta + \D[t]\log\left(1 - \tilde{L}(t)\right) - (\sigma - 1)\left(\mu - g(t) + (\sigma - 1)\frac{\upsilon^2}{2} \right)
\end{align}
To calculate the $\D[t]\log\left(1 - \tilde{L}(t)\right)$ you need to store the ``future'' $\left(1 - \tilde{L}(t)\right)$ and $t$ values in the last adaptive timestep, and then use forward first-differences with it based on the current value


\paragraph{Final Calculations}
Some additional calculations useful for analyzing the model, but not required for the calculation are
\begin{align}
	\lambda_{ii}(t) &= \frac{1}{1 + (N-1)\hat{z}(t)^{\sigma-1-\theta}d^{1-\sigma}}\label{eq:lambda-ii-t-summary}\\
c(t) &= \left(\frac{\theta}{1-\sigma+\theta}\right)^{\frac{1}{\sigma-1}}\left(1 - \tilde{L}(t)\right)\Omega(t)^{\frac{1}{\sigma - 1}} \lambda_{ii}(t)^{\frac{1}{1-\sigma}}\label{eq:c-summary}\\
\log M(t) &= \int_0^t g(s)\diff s\label{eq:log-M-summary}\\
U(t) &= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \frac{e^{-\rho( T-t)}}{\rho^2}\left((1+\rho( T-t))g(T) + \rho\left(\log c(T) + \log M(T) \right) \right)\label{eq:U-dynamics-summary}	
\end{align}


\newpage
\appendix
\makeatletter
\def\@seccntformat#1{Appendix\ \csname the#1\endcsname\quad}
\makeatother
\makeatletter
\def\@seccntformat#1{\csname Pref@#1\endcsname \csname the#1\endcsname\quad}
\def\Pref@section{Appendix~}
\makeatother
\numberwithin{equation}{section}
%\let\normalsize\small
%\small
\section{Derivations for Simple Model}\label{sec:simple-derivation}
\subsection{Equations Prior to Rescaling}

Copying from BPT2 (but renaming the $v$ function to $\hat{v}$ here), assume an exogenously given $\hat{\pi}(z,t)$ and $x(t)$ function.  We will only look at examples where $F(z) = 1 - e^{-\theta z}$ for all $t$.
\begin{align}
(r - g(t)) \hat{v}(z,t) &= \hat{\pi}(z,t) + (\mu- g(t)) \D[z] \hat{v}(z,t) + \frac{\upsilon^2}{2} \D[zz] \hat{v}(z,t) + \D[t]\hat{v}(z,t)\label{eq:bellman-GBM-dynamic}	\\
\hat{v}(0,t) &= \int_{0}^{\infty} \hat{v}(z,t) F'(z)\diff z - x(t)\label{eq:vm-GBM-dynamic}\\
\D[z]\hat{v}(0,t) &= 0\label{eq:sp-GBM-dynamic}
\end{align}

A solution to this problem is a $g(t)$ and $\hat{v}(z,t)$ that fulfills the above equations for all $t\in[0,T]$ and $z\in[0,\infty)$.  While not listed above, in practice another boundary condition (e.g. transversality) is used to ensure that \cref{eq:bellman-GBM-dynamic} can be solved. We us, a reflecting barrier at a ``large'' $\bar{z}$ converges to the correct solution.  Use the boundary value\footnote{Keep in mind that this is just a step in the numerical solution, rather than introducing a true reflecting barrier.  We will need to verify that it does not introduce issues by verifying the numeric solution matches the closed form solution for large $\bar{z}$ and compare to the analytic equation for external validity.  Also note that if $\upsilon = 0$, due to the upwind procedure this boundary value would be unnecessary and/or drop out of the solution.}
	\begin{align}
	\D[z]\hat{v}(\bar{z},t) &= 0\label{eq:reflecting-GBM-dynamic}
	\end{align}
	

\subsection{Change of Variables to Normalize and Rescale}\label{eq:simple-rescale}
Solving \cref{eq:bellman-GBM-dynamic} for $\hat{v}(z,t)$ is problematic since the scale goes from approximatively $1$ to $e^{\bar{z}}$, which is very large for a high $\bar{z}$.  To make the solution more stable, we rescale the equation.  Choose some $\xi \geq 0$ for convenience and to ensure stability and let
\begin{align}
	v(z,t) &\equiv e^{-\xi z}\hat{v}(z,t) = e^{-\xi z}\frac{V(e^z M(t),t)}{M(t)}\\
	\intertext{Differentiate and reorganize this expression to yield}
	\D[z]\hat{v}(z,t) &= e^{\xi z}\left(\xi v(z,t) + \D[z]v(z,t) \right)\\
	\D[zz]\hat{v}(z,t) &= e^{\xi z}\left(\xi^{2} v(z,t) + 2 \xi\D[z]v(z,t) + \D[zz]v(z,t)  \right)\\	
	\D[t]\hat{v}(z,t) &= e^{\xi z} \D[t]v(z,t)
\end{align}
Define $\pi(z,t) = e^{-\xi z}\hat{\pi}(z,t)$ so that if $\hat{\pi}(z,t) = e^{\xi z}$ then $\pi(z,t) = 1$.  Substitute into \cref{eq:bellman-GBM-dynamic}, divide by $e^{\xi z}$ and simplify,

\begin{align}
	\left(r - g(t)- \xi(\mu-g(t)) - \frac{\upsilon^2}{2}\xi^2\right)  v(z,t) &= \pi(z,t) + (\mu+ \upsilon^2\xi - g(t)) \D[z]v(z,t) \nonumber \\ &+ \frac{\upsilon^2}{2} \D[zz]v(z,t) + \D[t]v(z,t)  \label{eq:bellman-GBM-dynamic-normalized}
\end{align}

Now, substitute into the boundary conditions \cref{eq:sp-GBM-dynamic,eq:reflecting-GBM-dynamic} to find,
\begin{align}
	\xi v(0,t) + \D[z]v(0,t ) &= 0\label{eq:new-BC1}\\
	\xi v(\bar{z},t) + \D[z]v(\bar{z},t) &= 0\label{eq:new-BC2}
\end{align}	
Finally, in the value matching condition, $\hat{v}(0,t) = e^{0} v(0,t)$ where if the $F'(z) = \theta e^{-\theta z}$ then,
\begin{align}
	 v(0,t) &= \int_{0}^{\infty}  v(z,t) \left(e^{\xi z} F'(z)\right) \diff z - x(t)\label{eq:vm-GBM-dynamic-normalized-not-truncated}
\end{align}	
However, for the numerical approximation with the artificial boundary at $\bar{z}$, we need to use a truncated distribution for $F(z)$.  Since we have take the $F(z)$ with support from $[0,\infty)$, and we truncate at $\bar{z} = \bar{z}$ then the equation in \cref{eq:vm-GBM-dynamic-normalized-not-truncated} to work with is,
\begin{align}
	 v(0,t) &= \int_{0}^{\bar{z}}  v(z,t) \left(e^{\xi z} \frac{F'(z)}{F(\bar{z})}\right) \diff z - x(t)\label{eq:vm-GBM-dynamic-normalized}
\end{align}


\subsection{Quadrature}\label{sec:quadrature}
With the discretized grid, the integral in \cref{eq:vm-GBM-dynamic-normalized} will be calculated with some quadrature rules.\footnote{An issue here is that the support of the integral is infinite, but the finite differences go to $z_I$.  While not ideal, since $F'(z_I)\to 0$ rapidly, the Trapezoidal rule should be a  reasonable approximation.}  Most generally, let the quadrature rule weights be $\bar{\omega} \in \R^I$ where for some $q(z)$ and $q \equiv \set{q(z_i)}_{i=1}^I$,
\begin{align}
\int_0^{\bar{z}} q(z) \diff z &\approx \bar{\omega} \cdot q
\intertext{To derive the non-uniform trapezoidal rules for an arbitrary $q$ function,}
\int_{z_1}^{z_I} q(z)\diff z &\approx \frac1{2}\sum_{i=1}^{I-1}(z_{i+1}-z_i)(q(z_i) + q(z_{i+1}))\\
&= \frac1{2}\left(\Delta_{1,+}q(z_1) + (\Delta_{1,+} + \Delta_{2,+})q(z_2) + \ldots (\Delta_{I-2,+} + \Delta_{I-1,+})q(z_{I-1})+\Delta_{I-1,+}q(z_I)\right)
\intertext{If we set $\Delta_{1,-} = 0$ and $\Delta_{I,+} = 0$ then, (Note different than other use of ghost nodes in derivatives, though not sure they enter equations in those other cases)}
\int_{z_1}^{z_I} q(z)\diff z &\approx \bar{\omega}\cdot q\\
\intertext{where,}
\bar{\omega}&\equiv \frac1{2}(\Delta_{-} + \Delta_{+})
\end{align}


Moving to the specific integral in \cref{eq:vm-GBM-dynamic-normalized}, define the $\omega$ weights to combine the $\bar{\omega}$ and the $\left(e^{\xi z} \frac{F'(z)}{F(\bar{z})}\right)$ term so that
\begin{align}
\omega_i &\equiv \bar{\omega}_i e^{\xi z_i}\frac{F'(z_i)}{F(\bar{z})}\\
\intertext{Then with the discretized vector $v(t) \in \R^I$, the integral in \cref{eq:vm-GBM-dynamic-normalized} becomes,}
v_1(t) &= \omega \cdot v(t) - x(t)
\end{align}

\section{Derivations of Full Model}\label{sec:full-model-derivations}
\subsection{Normalization and Rescaling}\label{sec:full-rescaling}
Note that unlike the PTW paper we have $z \equiv \log(Z/M(t))$ throughout these notes.  The value is normalized as $\hat{v}(z,t) = \frac{V(e^z M(t),t)}{M(t)w(t)}$.  With this,
\begin{align}
V(Z,t) &:= w(t) M(t) \hat{v}(t, \log(Z/M(t)))\label{eq:V-norm}\\
\intertext{Differentiate \cref{eq:V-norm} with respect to $t$, divide by $w(t)M(t)$, and use the definitions $z := \log(Z/M(t)), g(t):= M'(t)/M(t)$ and $g_w(t) := W'(t)/W(t)$}
\frac{1}{w(t) M(t)}\D[t]V(Z,t) &= \left(g(t) + g_w(t)\right)\hat{v}(z,t) - g(t)\D[z]\hat{v}(z,t) + \D[t]\hat{v}(z,t) \label{eq:dV-dt}\\
\intertext{Similarly differentiate \cref{eq:V-norm} with respect to $Z$,}
\frac{1}{w(t) M(t)}\D[Z]V(Z,t) &= \frac{1}{Z}\D[z]\hat{v}(z,t)\label{eq:dV-dZ}\\
\frac{1}{w(t) M(t)}\D[ZZ]V(Z,t) &= \frac{1}{Z^2}\left(\D[zz]\hat{v}(z,t)-\D[z]\hat{v}(z,t)\right)\label{eq:dV-dZZ}
\end{align}
Take the unnormalized Bellman equation from the paper, repeated below,
\begin{align}
r(t) V(Z,t) &=  \Pi(Z,t)+ \left(\mu + \frac{\upsilon^2}{2}\right) Z\, \D[Z]V(Z,t)+ \frac{\upsilon^2}{2} Z^2 \D[ZZ]V(Z,t) +  \D[t]V(Z,t), \label{ap-eq:bellman-deterministic-prenorm}
\intertext{Use $\pi(z,t) \equiv \frac{\Pi(Z,t)}{w(t)M(t)}$ with the new $z$, divide \cref{ap-eq:bellman-deterministic-prenorm} $w(t)M(t)$ and then use \cref{eq:dV-dt,eq:dV-dZ,eq:dV-dZZ} to find,}
(r(t) - g(t) - g_w(t))\hat{v}(z,t) &= \pi(z,t) + (\mu - g(t))\D[z]\hat{v}(z,t) + \frac{\upsilon^2}{2}\D[zz]\hat{v}(z,t) + \D[t]\hat{v}(z,t)\label{eq:normalized-bellman}
\intertext{The smooth pasting condition, $\D[Z]V(M(t),t) = 0$ becomes}
\D[z]\hat{v}(0,t) &= 0\label{eq:normalized-sp}
\intertext{Take the value matching condition from the paper and divide by $M(t)w(t)$,}
\frac{{V}(M(t),t)}{M(t)w(t)} &= \int_{M(t)}^{\infty}\frac{{V}(Z,t)}{M(t)w(t)} \phi(Z,t) \diff Z - \frac{X(t)}{M(t)w(t)}
\intertext{Substitute for $\hat{v}(z,t)$ and $x(t) \equiv \frac{X(t)}{M(t)w(t)}$,}
\hat{v}(0,t) &= \int_{0}^{\infty}\hat{v}(\log(Z/M(t)),t) \phi(Z,t) \diff Z - x(t)
\intertext{With a change of variables in the integral to  $z = \log(Z/M(t))$,}
\hat{v}(0,t) &= \int_{0}^{\infty}\hat{v}(z,t) f(z,t) \diff z - x(t)\label{eq:normalized-vm}
\intertext{We will only solve versions of the model starting from a stationary Pareto distribution with tail index $\theta$ and minimum $M(t)$, so if $\phi(Z,t) = \theta M(t)^{\theta}Z^{-(1+\theta)}$ then}
f(z) &= \theta e^{-\theta z}\label{eq:f-stationary}
\end{align}
for all $t$.  It can be proven that this will be maintained by the KFE in the setup for any $g(t)$ sequence.

While this transformation could be done all at once, we will base it off of the previous section for easier comparison.  Define the following
\begin{align}
v(z,t) &\equiv e^{-(\sigma - 1)z}\hat{v}(z,t)\label{eq:v-tilde}\\
\pi(z,t) &\equiv e^{-(\sigma - 1)z}\hat{\pi}(z,t)
\end{align}
Rearrange and differentiate \cref{eq:v-tilde},
\begin{align}
\D[t]\hat{v}(z,t) &= e^{(\sigma - 1)z} \D[t]v(z,t)\label{eq:v-tilde-dt}\\
\D[z]\hat{v}(z,t) &= e^{(\sigma - 1)z}\left((\sigma - 1) v(z,t) + \D[z]v(z,t) \right)\label{eq:v-tilde-dz}\\
\D[zz]\hat{v}(z,t) &= e^{(\sigma - 1)z}\left((\sigma - 1)^2 v(z,t) + 2(\sigma - 1)\D[z]v(z,t) + \D[zz]v(z,t)\right)\label{eq:v-tilde-dzz}\\
\intertext{And at the adoption threshold, from \cref{eq:v-tilde-dz}}
\D[z]\hat{v}(0,t) &= (\sigma - 1) v(0,t) + \D[z]v(0,t)\label{eq:vt-0-dz}
\end{align}

To use these substitutions, start with \cref{eq:normalized-vm} and use the definition of $f(z)$,
\begin{align}
v(0,t) &= \theta \int_{0}^{\infty} v(z,t) e^{(-\theta + \sigma - 1)z} \diff z - x(t)\label{eq:normalized-vm-summary-rescaled}\\
\intertext{Combine \cref{eq:normalized-sp,eq:vt-0-dz} to get}
0 &= (\sigma - 1) v(0,t) + \D[z]v(0,t)\label{eq:normalized-sp-summary-rescaled}
\intertext{Finally, substitute all of the derivatives into \cref{eq:normalized-bellman} and divide by $e^{(\sigma - 1)z}$}	
\tilde{\rho}(t)  v(z,t) &= \pi(z,t) + (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z]v(z,t) + \frac{\upsilon^2}{2}\D[zz]v(z,t) + \D[t]v(z,t)
\intertext{where,}
\tilde{\rho}(t) &\equiv  r(t) - g(t) - g_w(t) - (\sigma - 1)\left(\mu - g(t) + (\sigma - 1)\frac{\upsilon^2}{2} \right)\label{eq:rhot}	
\end{align}	

\noindent From (PTW.C.26 to C.28) using the $z\equiv\log(Z/M(t))$ definition,
\begin{align}
	\hat{\pi}(z,t) &= \pi_{\min}(t) e^{(\sigma - 1)z}\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa\indicator{z \geq \log(\hat{z}(t))}\label{eq:pi-z-t-summary}
\intertext{Multiply by $e^{-(\sigma - 1)z}$ to get,}
\pi(z,t) &\equiv \bar{\pi}_{\min}(t)\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa e^{-(\sigma - 1)z}\indicator{z \geq \log(\hat{z}(t))}
\end{align}	




%\subsection{Summarizing Normalized Equations}\label{sec:normalized-equations}
%Take as given $g(t),\pi_{\min}(t),\hat{z}(t), x(t)$, and $\tilde{r}(t)$(alternatively $g_w(t)$ and $r(t)$).  Then, the following equations must be fulfilled for all $t$ and  $z$
%\begin{align}
%\tilde{r}(t) \equiv & r(t) - g(t) - g_w(t)\label{eq:r-tilde-summary}\\
%f(z) &= \theta e^{-\theta z}\label{eq:f-stationary-summary}\\
%\tilde{r}(t) \hat{v}(z,t) &= \hat{\pi}(z,t) + (\mu - g(t))\D[z]\hat{v}(z,t) + \frac{\upsilon^2}{2}\D[zz]\hat{v}(z,t) + \D[t]\hat{v}(z,t)\label{eq:normalized-bellman-summary}\\
%\D[z]\hat{v}(0,t) &= 0\label{eq:normalized-sp-summary}\\
%\hat{v}(0,t) &= \int_{0}^{\infty}\hat{v}(z,t) f(z) \diff z - x(t)\label{eq:normalized-vm-summary}\\
%\end{align}



\subsection{Free-entry Condition}\label{sec:free-entry}
To determine the $E(t)$ function, we need the free entry complementarity condition to hold.  Note that (PTW D.19) actually holds for any $t$ as well, and does not require the stationary solution.  From (PTW D.19) and using $v(t,0) = \hat{v}(t,0)$, we see that if $E(t) > 0$ that,
\begin{align}
v(t,0) &= \zeta \frac{1-\chi}{\chi}
\intertext{In the case that there is no entry, and $E(t) = 0$ for some $t$, from (D.18)}
v(0,t) &< \zeta \frac{1-\chi}{\chi}
\end{align}

\subsection{Derivation of Rates of Change and Interest Rates}\label{sec:derive-interest-rates}
Since consumption is $C(t) := c(t) M(t)$, take logs and differentiate to get,
\begin{align}
\D[t]\log C(t) &= g(t) + g_c(t)
\intertext{With a CRRA parameter of $\gamma \geq 0$, the interest rate rate faced by a firm is,}
r(t) &= \rho + \delta + \gamma \D[t]\log C(t)\\
&= \rho+ \delta + \gamma(g_c(t)+ g(t))\label{eq:r-def}
\end{align}

\noindent This can be simplified in some cases.  From the PTW (C.34), for $\eta = 0$,
 \begin{align}
 \frac{c(t)}{w(t)}&\propto 1 - \tilde{L}(t) 
 \intertext{Taking the log and differentiating,}
g_c(t) - g_w(t) &= \D[t]\log\left(1 - \tilde{L}(t)\right)\label{eq:g-c-w-diff}
\intertext{Define,}
\tilde{r}(t) &\equiv r(t) - g(t) - g_w(t)\\
\intertext{From \cref{eq:r-def}}
&= \rho + \delta + \gamma(g_c(t)+ g(t)) - g(t) - g_w(t)\\
&= \rho + \delta + (g_c(t) - g_w(t)) + (\gamma - 1)(g_c(t) + g(t))\\
\intertext{From \cref{eq:g-c-w-diff}}
&= \rho + \delta + \D[t]\log\left(1 - \tilde{L}(t)\right) + (\gamma - 1)(g_c(t) + g(t))\\
\intertext{And in the $\log$ utility case with $\gamma = 1$, the last term drops, so that we have,}
 \tilde{r}(t) &=  \rho+ \delta + \D[t]\log\left(1 - \tilde{L}(t)\right)\label{eq:tilde-r-L}
 \end{align}

 
 \subsection{Derivations of Cutoffs and Profits}
 From (PTW H.11), the adoption cost relative to wages remains constant throughout the transition (i.e. assumed $\eta = 0$):
 \begin{align}
 x(t) &= \zeta\label{eq:x-zeta}
 \intertext{For the components of aggregate profits, we need to find $\pi_{\min}(t)$. In order to solve for the static $\hat{z}(t)$ condition, we will leave it as a variable in the equations.  Start with (PTW C.26)}
 \pi_{\min}(t) &= \frac{1-\tilde{L}(t)}{(\sigma-1)\bar{z}(t)^{\sigma-1}}\label{eq:pi-min-def}\\
 \intertext{From (PTW C.19), along the transition dynamics $E(t)$ is left general}
 \tilde{L}(t) &=\Omega(t)\left[(N-1)(1-F(\hat{z}(t)))\kappa + \zeta \left( S(t) + E(t)/\chi\right)\right]\label{eq:L-tilde-sub}\\
 &=\Omega(t)\left((N -1)\hat{z}^{-\theta}\kappa + \zeta \left(S(t) + E(t)/\chi \right)\right)\\
 \intertext{From (PTW C.10)}
 \bar{z}(t) &= \left[\Omega(t)\left(\expec{z^{\sigma - 1}} + (N-1)(1-F(\hat{z}(t)))d^{1-\sigma}\condexpec{z^{\sigma - 1}}{z > \hat{z}(t)}\right)\right]^{\frac{1}{\sigma - 1}}\\
 &= \left[\Omega(t)
 \frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{-\theta}\left(\frac{\hat{z}}{d} \right)^{\sigma - 1 -\theta} \right)\right]^{\frac{1}{\sigma - 1}}\label{eq:z-bar-sub}\\
 \end{align}	
 
 Hence,
 \begin{align}
 \bar{z}(t)^{\sigma - 1}&= \Omega(t)
 \frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{1-\sigma}\hat{z}^{\sigma - 1 -\theta} \right)\label{eq:z-bar-sub-power}\\
 \intertext{Use (PTW C.29)}
 \hat{z}(t)&= d \left(\tfrac{\kappa}{\bar{\pi}_{\min}(t)} \right)^{\frac{1}{\sigma - 1}}\label{eq:z-hat-def}
\intertext{Reorganize \cref{eq:z-hat-def} to find an implicit equation in $\hat{z}$ at every $t$,}
 0&=\hat{z}^{\sigma-1}-  \kappa d^{\sigma - 1} \bar{\pi}_{\min}(t)^{-1}\label{eq:z-hat-power}
 \end{align}
 Note that \cref{eq:z-hat-power} provides an implicit equation in $\hat{z}(t)$ given an exogenous $\Omega(t)$ and $g(t)$ and \cref{eq:L-tilde-sub}, and can be solved separately for each $t$.  From the implicit $\hat{z}(t)$, calculate the home trade share through (PTW C.47),
 \begin{align}
 \lambda_{ii}(t) &= \frac{1}{1 + (N-1)\hat{z}(t)^{\sigma-1-\theta}d^{1-\sigma}}\label{eq:lambda-ii-t}\\
\intertext{Use (PTW C.49) to calculate,}
 \bar{\pi}_{\min}(t) &= \frac{(N-1) \hat z(t) ^{-\theta}\kappa}{1-\lambda_{ii}(t)} \label{eq:pi-bar-t}
 \end{align}

\subsection{Welfare Calculations}
Assume that there is a $T > 0$ such that the equilibrium reaches a steady state.   Given that $g(t) \equiv \D[t]\log M(t)$.  With this,
\begin{align}
M(t) &=M(0)\times\begin{cases}
\exp\left(\int_0^t g(s)\diff s \right) & \text{ if } 0 \leq t \leq T\\
\exp\left(\int_0^{T} g(s)\diff s  + (t - T)\bar{g} \right) & t \geq T
\end{cases}\label{eq:M-t-sol}
\intertext{Assume wlog that $M(0) = 1$, then,}
\log M(t) &= \int_0^t g(s)\diff s\label{eq:log-M}
\end{align}

At the steady state, define $\bar{g}$ and $\bar{c}$ as the growth rate and consumption relative to real wages for $t \geq T$.  The consumer welfare can be calculated as from (PTW 1),
\begin{align}
U(t) &= \int_0^{\infty}e^{-\rho \tau}\log C(t+\tau)\diff \tau\\
&= \int_0^{\infty}e^{-\rho \tau}\log M(t+\tau) \diff \tau + \int_0^{\infty}e^{-\rho \tau}\log c(t+\tau)\diff \tau\label{eq:U-def}
\intertext{Given the convergence at time $T$, use \cref{eq:U-def} to split the welfare integral,}
U(t) &= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \int_{T-t}^{\infty}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau\\
\intertext{Note that $c(t)= \bar{c}$ for $t \geq T$,}
&= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \frac{e^{-\rho( T-t)}}{\rho^2}\left((1+\rho( T-t))\bar{g} + \rho\left(\log \bar{c} + \log M(T) \right) \right)\label{eq:U-dynamics}
%	\intertext{With \cref{eq:M-t-sol}}
%	&= \int_0^{T}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \frac{e^{-\rho( T-t)}}{\rho^2}\left((1+\rho( T-t))g(T) + \rho\left(\log \bar{c} + \log M(T) \right) \right)
\intertext{With (PTW G.31) and (PTW G.33) and \cref{eq:f-stationary-summary}}
c(t) &= \left(\frac{\theta}{1-\sigma+\theta}\right)^{\frac{1}{\sigma-1}}\left(1 - \tilde{L}(t)\right)\Omega(t)^{\frac{1}{\sigma - 1}} \lambda_{ii}(t)^{\frac{1}{1-\sigma}}\label{eq:c-def}
\end{align}



\section{Discretization}\label{sec:discretization}
\subsection{Discretizing the State Space}\label{eq:discretization}
This will discretize space with backward differences in the first derivative, and central in space for the 2nd derivative.\footnote{Under a $g(t) > \gamma$ assumption (which may be a general requirement on parameter restrictions), the drift is negative, and the correct ``upwind'' finite difference scheme is always backwards.}  After discretizing the spatial dimension, we have a system of ODEs in time - which are solved using various time-stepping algorithms.

\begin{itemize}
	\item Define a  grid $\set{z_i}_{i=1}^I$ with $z_1 = 0$ and $z_I = \bar{z}$ is a ``large'' number (keeping in mind that the effective number is $e^{\bar{z}}$).  After discretizing, we will denote the grid with the variable name, i.e. $z \equiv \set{z_i}_{i=1}^I$.
	\item Denote the distance between the grid points as the \textit{backwards} difference
	\begin{align}
			\Delta_{i,-} &\equiv z_i - z_{i-1},\, \text{for } i = 2,\ldots I\\
			\Delta_{i,+} &\equiv z_{i+1} - z_i,\, \text{for } i = 1,\ldots I-1
	\end{align}
	\item Assume $\Delta_{1, -} = \Delta_{1, +}$ and $\Delta_{I, +} = \Delta_{I, -}$, due to ghost points, $z_0$ and $z_{I+1}$ on both boundaries. (i.e., the distance to the ghost nodes are the same as the distance to the closest nodes).  Then define the vector of backwards and forwards first differences as
	\begin{align}
		\Delta_{-} &\equiv \begin{bmatrix} z_2 - z_1 \\
			\text{diff}(z)
		\end{bmatrix}\\
		\Delta_{+} &\equiv \begin{bmatrix} \text{diff}(z)\\
			z_I - z_{I-1}
		\end{bmatrix}
	\end{align}
	\item The grid on time $t \in [0,T]$ may be adaptive, and we will let the ODE solver handle the grid.	
	\item Assume a grid of $I$ discrete points in $z$ and $N$ discrete points in time, then denote the value as
	\begin{align}
		v(t) &\equiv \set{v(z_i, t)}_{i=1}^I\in\R^I
	\end{align}
\item Given the exogenous $\hat{\pi}(z,t)$ functions, the discretized equivalents is $\hat{\pi}(t) \in \R^I$.
\end{itemize}

\subsection{Discretization Operators}\label{sec:discretization-operators}
Summarizing the discretized differential operators subject to the boundary conditions.  Let $L_1^{-}$ be the discretized backwards first differences, subject to \cref{eq:new-BC1,eq:new-BC2} and $L_2$ be the discretized central differences subject to \cref{eq:new-BC1,eq:new-BC2}.

Then you can show that the following  

\begin{align}
L_1^{-} &\equiv \begin{bmatrix} TODO \end{bmatrix}\\
	L_2 &\equiv \begin{bmatrix}  TODO \end{bmatrix}
\end{align}

\subsection{Spatial Discretization}\label{sec:spatial-discretization}


\textbf{TODO:} This section should be replaced with the operator composition approach.  Note that the boundary conditions are homogenous, which is why the composition works wit.

\paragraph{Interior of $L$:}
To better understand the construction of $A$ and $b$, look at individual rows of $A$ with the ODE.\footnote{Note that the first derivative is not using central differences.  This is to ensure it is upwind, and hence that this is a monotone sequence, even for vanishing $\sigma$.

\begin{align}
\D[z]v(z_i, t_n) &\approx \frac{v_i^n - v_{i-1}^n}{\Delta_{i,-}}\label{eq:D-v-z}\\
\intertext{And use non-uniform central differences for the 2nd derivative}
\D[zz]v(z_i, t_n) &\approx \frac{\Delta_{i,-}v^n_{i+1} - (\Delta_{i,-}+\Delta_{i,+})v^n_i+\Delta_{i,+}v^n_{i-1}}{\frac1{2}(\Delta_{i,+}+\Delta_{i,-})\Delta_{i,-}\Delta_{i,+}}\label{eq:D-v-zz}
\end{align}
If the $z$ grid is uniform, the central differences should end up as just
\begin{align}
	\D[zz]v(z_i, t_n) &\approx \frac{v_{i+1}^n - 2 v_i^n + v_{i-1}^n}{\Delta^2}\label{eq:D-v-zz-uniform}
\end{align}
}

In the interior ($1 < i < I$), the discretization of finite difference operator is with drift $\mu_i$ split into upwind components is:
\begin{align}
\mathcal{A} v(z_i) 
&= \underbrace{\left(-\frac{\mu_i^{-}}{\Delta_{i,-}} +\frac{\sigma_i^2}{\Delta_{i,-}(\Delta_{i,+}+\Delta_{i,-})}\right)}_{\equiv X_i}v_{i-1} + \underbrace{\left(\frac{\mu_i^{-}}{\Delta_{i,-}} - \frac{\mu_i^{+}}{\Delta_{i,+}}-\frac{\sigma_i^2}{\Delta_{i,-}\Delta_{i,+}}\right)}_{\equiv Y_i}v_i +\nonumber\\ &\underbrace{\left(\frac{\mu_i^{+}}{\Delta_{i,+}} + \frac{\sigma_i^2}{\Delta_{i,+}(\Delta_{i,+}+\Delta_{i,-})}\right)}_{\equiv Z_i}v_{i+1}\label{eq:A-collected-interior-with-nonuniform-grid}
\end{align}

\paragraph{Boundary Value at $x=0$:}
If the boundary value is $\xi v(0,t) + \D[z]v(0,t )= 0$, use the backward difference approximation $v'(z_i) \approx \frac{v_i-v_{i-1}}{\Delta_{i,-}}$.  Then substituting into the boundary condition we get
\begin{align}
0 = \xi v(0,t) + \D[z]v(0,t ) &\approx \xi v_1 + \frac{v_1-v_0}{\Delta_{1,-}}\\
\intertext{Rearrange, use $\Delta_{1,-} = \Delta_{1,+}$, and solve for $v_0$,}
v_0 &= (1 + \xi \Delta_{1,+})v_1\label{eq:rescaled-bc-sub}\\
\intertext{Now, take \cref{eq:A-collected-interior-with-nonuniform-grid}, and remember that given a $v_0$ the function is well defined under the assumption that $\Delta_{1,-} = \Delta_{1,+}$}
\mathcal{A} v(z_1) &\approx X_1 v_0 + Y_1 v_1 + Z_1 v_2
\intertext{Substitute in \cref{eq:rescaled-bc-sub} to get}
\mathcal{A} v(z_1) &\approx \left((1 + \xi \Delta_{1,+})X_1 + Y_1\right) v_1 + Z_1 v_2\label{eq:reflecting-left-nonuniform}
%\intertext{Substitute this into \cref{eq:A-collected-with-nonuniform-grid-left}}
% &\approx \left(\underbrace{\left(\frac{-\mu_1^{-}}{\Delta_{1,-}} +\frac{\sigma_1^2}{\Delta_{1,-}(\Delta_{1,+}+\Delta_{1,-})}\right)}_{\equiv X_1}(1+\Delta_{1,-}) + \underbrace{\left(\mu_1^{-} - \frac{\mu_1^{+}}{\Delta_{1,+}}-\frac{\sigma_1^2}{\Delta_{1,+}\Delta_{1,-}}\right)}_{\equiv Y_1}\right)v_1 + \nonumber\\
% & \underbrace{\left(\frac{\mu_1^{+}}{\Delta_{1,+}} + \frac{\sigma_1^2}{2 \Delta_{1,+}\Delta_{1,-}}\right)}_{\equiv Z_1}v_2\label{eq:reflecting-left-nonuniform}
\end{align}
So from \cref{eq:reflecting-left-nonuniform} the top left corner of $A$ matrix is now $\left((1 + \xi \Delta_{1,+})X_1 + Y_1\right)$.  Note that this nests the typical reflecting barrier since if the scaling is $e^{0} = 1$, then the corner, is $X_1 + Y_1$, matches the standard reflecting barrier without rescaling.

\paragraph{Boundary Value at $\bar{z}$}
If the boundary value is $\xi v(\bar{z},t) + \D[z]\tilde{\bar{z}}(0,t )= 0$, use the forward difference approximation $v'(z_i) \approx \frac{v_{i+1}-v_{i}}{\Delta_{i,+}}$.  Then substituting into the boundary condition we get
\begin{align}
0 = \xi v(\bar{z},t) + \D[z]v(\bar{z},t ) &\approx \xi v_I + \frac{v_{I+1}-v_I}{\Delta_{I,+}}\\
\intertext{Rearrange and solve for $v_0$ and use $\Delta_{I,+} = \Delta_{I,-}$,}
 v_{I+1} &= (1 - \xi \Delta_{I,-}) v_I\label{eq:rescaled-bc-sub-right}\\
\intertext{Now, take \cref{eq:A-collected-interior-with-nonuniform-grid}, and remember that given a $ v_{I+1}$ the function is well defined under the assumption that $\Delta_{I,-} = \Delta_{I,+}$}
\mathcal{A}  v(z_I) &\approx X_1  v_{I-1} + Y_1  v_I + Z_1  v_{I+1}
\intertext{Substitute in \cref{eq:rescaled-bc-sub-right} to get}
\mathcal{A}  v(z_I) &\approx X_I  v_{I-1} + \left(Y_I + (1 - \xi \Delta_{I,-})Z_I\right)  v_I\label{eq:reflecting-right-nonuniform}
\end{align}
So from \cref{eq:reflecting-right-nonuniform} the bottom right corner of $A$ matrix is now $\left(Y_I + (1 - \xi \Delta_{I,-})Z_I\right)$.  Note that this nests the typical reflecting barrier since if the scaling is $e^{0} = 1$, then the corner, is $X_1 + Y_1$, matches the standard reflecting barrier without rescaling.

%Can remove if we think the above is correct
% \paragraph{Boundary Value at $\bar{z}$:}
% As $i=I$, given the ``ghost node'' $z_{I+1}$, and the assumption  $\Delta_{I,+} = \Delta_{I,-}$, from \cref{eq:A-collected-interior-with-nonuniform-grid}:
% \begin{align}
% \mathcal{A}   v(x_I)&\approx \left(-\frac{\mu_I^{-}}{\Delta_{I,-}} +\frac{\sigma_I^2}{2 \Delta_{I,-}^2}\right) v_{I-1} + \left(\frac{\mu_I^{-} - \mu_I^{+}}{\Delta_{I,-}}-\frac{\sigma_I^2}{\Delta_{I,-}^2}\right) v_I + \left(\frac{\mu_I^{+}}{\Delta_{I,-}} + \frac{\sigma_I^2}{2 \Delta_{I,-}^2}\right) v_{I+1}\\
% \intertext{For a reflecting barrier, the boundary value $v'(\bar{z}) \approx \frac{ v_{I+1}- v_I}{\Delta_{I,+}}+ v_{I} = 0, \implies  v_{I+1} = (1-\Delta_{I,+}) v_I$,}
% &\approx \underbrace{\left(-\frac{\mu_I^{-}}{\Delta_{I,-}} +\frac{\sigma_I^2}{\Delta_{I,-}(\Delta_{I,+}+\Delta_{I,-})}\right)}_{\equiv X_I}  v_{I-1}\nonumber\\
% &+ \left(\underbrace{\left(\frac{\mu_I^{-}}{\Delta_{I,-}} - \frac{\mu_I^{+}}{\Delta_{I,+}}-\frac{\sigma_I^2}{\Delta_{I,-}\Delta_{I,+}}\right)}_{\equiv Y_I} + \underbrace{\left(\frac{\mu_I^{+}}{\Delta_{I,+}} + \frac{\sigma_I^2}{\Delta_{I,+}(\Delta_{I,+}+\Delta_{I,-})}\right)}_{\equiv Z_I}(1-\Delta_{I,+}) \right)  v_I \label{eq:reflecting-right-nonuniform}
% \end{align}

\paragraph{Discretization Operator:} Apply the boundary conditions at the corner of discretization matrix:

\begin{align}
		A &\equiv \begin{bmatrix}
	X_1^n(1+\xi\Delta_{1,+})+Y_1^n & Z_1^n & 0 & \ldots & \ldots & \ldots & 0\\
	X^n_2 & Y^n_2 & Z^n_2 & 0 & 0 & \ldots & 0\\
	\vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots\\		
	0 & 0 & 0 & \ldots & X^n_{I-1} & Y^n_{I-1} & Z^n_{I-1}\\
	0 & \ldots & \ldots & \ldots & 0 & X_I^n & Y_I^n+Z_I^n(1-\xi\Delta_{I,-})
\end{bmatrix}\in\R^{I\times I}\label{eq:A-n}
\end{align}


\end{document}