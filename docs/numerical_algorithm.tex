% !TEX program = pdflatex

\documentclass[11pt]{article}
\usepackage{amsmath,amsfonts,amsthm,amssymb,geometry,dsfont}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage[
bookmarks=false,
pdfstartview={FitV},
pdftitle={Equilibrium Technology Diffusion, Trade, and Growth: Computational Appendix},
pdfauthor={Jesse Perla, Christopher Tonetti, Michael E. Waugh},
pdfcreator={Jesse Perla, Christopher Tonetti, Michael E. Waugh},
pdfkeywords={economics,international,growth,technology diffusion, trade, Perla, Tonetti, Waugh},
colorlinks=true,
linkcolor=darkgray,
citecolor=darkgray,
urlcolor=darkgray,
filecolor=darkgray,
anchorcolor=darkgray,
breaklinks]
{hyperref}
\usepackage[capitalise,noabbrev]{cleveref} %
\crefname{equation}{}{} %
\crefname{assumption}{Assumption}{Assumptions}
\crefname{property}{Property}{Properties}
\geometry{left=1in,right=1in,top=0.6in,bottom=1in}

\newcommand{\D}[1][]{\ensuremath{\boldsymbol{\partial}_{#1}}}
\newcommand{\R}{\ensuremath{\mathbb{R}}}
\newcommand{\diff}{\ensuremath{\mathrm{d}}}
\newcommand{\set}[1]{\ensuremath{\left\{{#1}\right\}}}
\newcommand{\indicator}[1]{\ensuremath{\mathds{1}\left\{{#1}\right\}}}
\newcommand{\condexpec}[3][]{\ensuremath{\mathbb{E}_{#1}\left[{#2} \; \middle| \; {#3} \right]}}
\newcommand{\expec}[2][]{\ensuremath{\mathbb{E}_{{#1}}\left[ {#2} \right]}}
\begin{document}
\title{Equilibrium Technology Diffusion, Trade, and Growth\\Online Computational Appendix\thanks{Thanks to Ben Moll for advice on numerical methods and his superb lecture notes.  Excellent research assistance was provided by Chiyoung Ahn, Sev Hou, Arnav Sood, and Dongxiao Zhang.}}
\author{Jesse Perla \and Christopher Tonetti \and Michael E. Waugh}
\maketitle

\section{Simplified Growth Model with Transition Dynamics}
We start with an simplified version of the model with transition dynamics.  In the more complicated case of this paper, the $\pi(z,t), r(t), x(t)$ will come from equilibrium conditions rather than being given exogenously, but the structure of solving the resulting system of integro-differential-algebraic equations remains the same.

There is a useful simplifying result in the both this simple and the full model: in the transition dynamics experiments we are looking at, the normalized distribution $F(z)$ will remain constant over all time.  Hence, we do not need to jointly solve the KFE as we will be at the stationary level (post-normalization).  This is a consequence of the PDF becomes stationary (after normalization) for this model and is \textbf{not} an assumption.

\subsection{Summary of Equations}\label{sec:summary-simple}
We follow the notation of the main paper wherever possible.  This model is the geometric Brownian motion (GBM) model in the technical appendix of Benhabib, Perla, and Tonetti (2019).

Let $Z$ be productivity, where $Z(t) \geq M(t)$.  Let $V(Z,t)$ is the value function prior to normalization, $M(t)$ the endogenous threshold, $\Pi(Z,t)$ the profits, and $X(t)$ the adoption cost.  The $\Pi(Z,t)$, $r$, and $X(t)$ are given exogenously in this simplified version, and endogenized with monopolistic competition and trade in the full model.

Define the normalization that $z \equiv \log(Z/M(t))$, $v(z,t) \equiv \frac{e^{-z}}{M(t)}V(M(t)e^z, t))$, $\pi(z,t) \equiv \frac{e^{-z}}{M(t)}\Pi(M(t)e^z, t))$, and $x(t) \equiv X(t)/M(t)$.  \cref{sec:simple-derivation} show the rescaled system of equations is
\begin{align}
\D[t]v(z,t) &= A(t)v(z,t) - \pi(z,t)\label{eq:simple-summary1}\\
v(0,t) &= \int_{0}^{\infty}  v(z,t) \left(e^z F'(z)\right) \diff z - x(t)\label{eq:simple-summary2}\\
\D[z]v(0,t) + v(0,t) &= 0\label{eq:simple-summary3}\\
\intertext{Given the differential operator,}
A(t) &\equiv \left(r - \mu - \frac{\upsilon^2}{2}\right) - (\mu+ \upsilon^2 - g(t)) \D[z] - \frac{\upsilon^2}{2} \D[zz]\label{eq:simple-summary4}\\
\intertext{And with the normalized BGP distribution as}
F(z) &= 1 - e^{-\theta z}
\end{align}

\subsection{Analytic Steady State}\label{sec:simple-steady-state}
For the exogenous $\pi(z,t)$ and $x(t)$ we require that at some $T < \infty$ it becomes stationary.  Hence we will assume with little loss of generality that,\footnote{Note that the $\pi(z,T) = 1$ requires that pre-normalized profits are $\Pi(Z,T) \propto e^Z$.  With different functional forms of the profits, we would rescale by a different power in the exponential--such as the $e^{-\xi z}$ in the full model.}
\begin{align}
x(t) &= \zeta,\quad \text{ for all }t \geq T\label{eq:terminal-x}\\
\pi(z,t) &= 1,\quad \text{ for all }t \geq T\label{eq:terminal-pi}\\
f(z,t) &= \theta e^{-\theta z},\quad \text{ for all }t \label{eq:f-stationary-summary}
\end{align}




\noindent Benhabib, Perla, and Tonetti (2019) gives us a closed-form solution for this balanced growth path (i.e steady state when normalized)

\begin{align}
g \equiv g(T) &= 	\mu+ \frac{1-(\theta -1) \zeta  \left(r-\mu\right)}{(\theta -1)^2 \zeta }+ \frac{\upsilon^2}{2}\frac{\theta  \left(\theta(\theta -1)    \left(r-\mu-\frac{\upsilon ^2}{2}\right) \zeta-2\right)+1}{(\theta -1) \left((\theta -1)   \left(r-\mu-\frac{\upsilon ^2}{2}\right)\zeta-1\right)}. \label{eq:g-gbm}\\
v(z,T) &= \frac1{r-\mu- \upsilon^2/2}\left(1 + \frac1{\nu} e^{-(\nu + 1) z}\right)\label{eq:v-gbm-sol},
\intertext{where,}
\nu &\equiv  \frac{\mu- g}{\upsilon^2} + \sqrt{\left(\frac{g-\mu}{\upsilon^2} \right)^{2} + \frac{r-g}{\upsilon^2/2}}. \label{eq:nu-gbm}
\end{align}

Note: since $v(z,T)$ has been rescaled by $e^{-z}$ above, it is now a \textbf{decreasing} function in $z$.  This will lead to appealing numerical properties when solving the PDE for $v(t,z)$ since it becomes asymptoptically constant as $z \to \infty$ for any $t$


\subsection{Summary of Equations For Numerical Solution}\label{sec:summary-simple-numerical}
To solve the model numerically, we need to bound the state space by adding an artificial upper bound, $\bar{z}$.  With this and using the derivation in \cref{sec:simple-derivation}, the equations of \cref{sec:summary-simple} become,

\begin{align}
\D[t]v(z,t) &= A(t)v(z,t) - \pi(z,t)\label{eq:simple-summary1-numerical}\\
v(0,t) &= \int_{0}^{\bar{z}}  v(z,t) \left(e^z \frac{F'(z)}{F(\bar{z})}\right) \diff z - x(t)\label{eq:simple-summary2-numerical}\\
\D[z]v(0,t) + v(0,t) &= 0\label{eq:simple-summary3-numerical}\\
\D[z]v(\bar{z},t) + v(\bar{z},t) &= 0\label{eq:simple-summary4-numerical}\\
\intertext{With the same operator $A(t)$ in \cref{eq:simple-summary4} now defined on $z \in [0,\bar{z}]$}
A(t) &\equiv \left(r - \mu - \frac{\upsilon^2}{2}\right) - (\mu+ \upsilon^2 - g(t)) \D[z] - \frac{\upsilon^2}{2} \D[zz]\label{eq:simple-summary5-numerical}
\end{align}

\noindent A solution to this equilibrium is a $g(t)$ and $v(z,t)$ fulfilling this system of equations

\subsection{Spatial Discretization with Upwind Finite-Differences}

In order to solve for the dynamics of $v(t,z)$ and $g(t)$, we will discretize the PDE, integral, and algebraic equations from \cref{eq:simple-summary1-numerical,eq:simple-summary2-numerical,eq:simple-summary3-numerical,eq:simple-summary4-numerical} into a system of ODEs and algebraic equations.\footnote{As a test, we solve the steady state version of the discretized system of ODEs numerically and compare it to \cref{sec:simple-steady-state} to determine the degree of numerical error and stability of the methods.}

\paragraph{Grid}

Define a  grid $\set{z_i}_{i=1}^M$ with $z_1 = 0$ and $z_I = \bar{z}$ is a ``large'' number (keeping in mind that the effective number is $e^{\bar{z}}$).  After discretizing, we will denote the grid with the variable name, i.e. $z(t) \equiv \set{z_i(t)}_{i=1}^M$.  Given the exogenous $\pi(z,t)$ functions, the discretized equivalents is $\pi(t) \in \R^M$.

\paragraph{Discretized Operator}

To discretize the system, we use upwind finite differences.  In particular, we need to discretize the differential operator in \cref{eq:simple-summary5-numerical} subject to the \cref{eq:simple-summary3-numerical,eq:simple-summary4-numerical} boundary conditions.  Crucially, since these boundary conditions are homogeneous, we can decompose the linear $A(t)$ operator into additive parts where: the $\D[z]$ is discretized as $L^{-}_1$ using backwards differences, and the $\D[zz]$ is discretized as $L_2$ using central difference.   Furthermore, the $L^{-}_1$ and $L_2$ linear operators \textit{impose the boundary condition for any vector} they operator on.\footnote{See \url{https://github.com/JuliaDiffEq/PDERoadmap} for more on the theory of discretizing operators with affine boundary conditions.}

Using the derivations in \cref{sec:discretization-operators}, the discretization of $A(t)$ subject to the boundary conditions is then the $M \times M$ matrix
\begin{align}
A(t) &\equiv \left(r - \mu - \frac{\upsilon^2}{2}\right) I - (\mu + \upsilon^2 - g(t)) L^{-}_1 - \frac{\upsilon^2}{2} L_2\label{eq:A-def-simple}
\end{align}
where $I$ is the identity matrix.

In order to check that the  $L^{-}_1$ backwards differences is the correct upwind direction, it is best to verify that\footnote{In the steady-state, this equation will be fulfilled for any non-degenerate solutions, but it is best to check this result at a few points in the transition path for off-equilibrium steps in the numerical algorithm.}
\begin{equation}
\mu + \sigma^2 - g(t) < 0
\end{equation}

\paragraph{Quadrature}
In order to discretize \cref{eq:simple-summary2-numerical}, we need to calculate the integral using quadrature.  Since the grid points are already given (i.e. we can't choose Gaussian quadrature nodes), we will use the weights for the non-uniform trapezoidal rule.

To calculate these, use $\Delta_{-}$ and $\Delta_{+}$ backwards and forward diffs (respectively) for the $z$ grid (with $\Delta_{1,-} = 0$ and $\Delta_{M,+} = 0$ set for the ghost nodes),
\begin{align}
\bar{\omega}&\equiv \frac1{2}(\Delta_{-} + \Delta_{+})
\end{align}

Then, in \cref{sec:quadrature}, we can combine both the quadrature nodes and all non-$v$ values at the nodes (i.e.$e^z$ and the $F'(z)$) with $\bar{\omega}$ so that
\begin{align}
\omega_i &\equiv \bar{\omega} \frac{\theta e^{(1 - \theta)z_i}}{1 - e^{-\theta \bar{z}}}
\end{align}

\noindent Using this definition, the integral is approximated by a linear operator $\omega\in\R^M$
\begin{align}
 \int_{0}^{\bar{z}}  v(z,t) \left(e^z \frac{F'(z)}{F(\bar{z})}\right) \diff z &\approx \omega \cdot v(t)
\end{align}

\subsection{Discretized Model as an DAE}
Let $v_1(t)$ be the $1$st element in the $v(t)$ vector, corresponding to $v(0,t)$.  Then, the value matching condition in \cref{eq:simple-summary2-numerical,eq:simple-summary1-numerical} along with the system of ODEs becomes the differential-algebraic equation (DAE)
\begin{align}
	v'(t) &= A(t) v(t) - \pi(t)\label{eq:discretized-simple}\\
	0 &= v_1(t) - \omega \cdot v(t) + x(t)\label{eq:discretized-simple-vm}
\end{align}


To find the stationary solution at $T$,  $v'(T) = 0$, we can solve the nonlinear system of equations
\begin{align}
	0 &= A(T; g) v(T) - \pi(T)\label{eq:discretized-simple-stationary}\\
	0 &= v_1(T) - \omega \cdot v(T) + x(T)\label{eq:discretized-simple-vm-stationary}
\end{align}
Where the $ A(T; g)$ is to reinforce that it is the only component which is a function of $g$.  This can be solved by using a nonlinear solver for $v(T)$ and $g$, or by fixing $g$, solving the linear \cref{eq:discretized-simple-stationary} for $v(T)$ and then checking \cref{eq:discretized-simple-vm-stationary} for convergence of the $g$.

\subsection{Solving the Transition Dynamics}

Transition dynamics can be solved for any exogenous $x(t)$ and $\pi(z,t)$ functions defined on $t \in [0,\infty)$ where they remain constant after $T$.

The basic algorithm for this, which we have not seen in the literature, is to directly solve the system \cref{eq:discretized-simple,eq:discretized-simple-vm} as a DAE.\footnote{ We experimented extensively with the more typical method in the economics literature of guessing a path for $g(t)$, solving the discretized system as an ODE in \cref{eq:discretized-simple}, and then minimizing residuals of \cref{eq:discretized-simple-vm}.  For various reasons, this approach ended up being much slower and less stable for this particular problem, which led to the DAE solution.  While we were able to get solutions using this approach for the simple solution, it failed to effectively solve the full model dynamics in any reasonable time.}

\begin{itemize}
	\item Choose an appropriate $z$ grid, with a large number of points close to $0$ as well as near the $\bar{z}$.\footnote{There is a degree of sensitivity in this model for the particular choice of $\bar{z}$ and the grid points for several reasons: (a) the imposition of the \cref{eq:simple-summary3-numerical} condition on $\D[z]v(0,t)$  is analytically the correct boundary condition for the optimal stopping problem for the imitation threshold--it comes from the smooth-pasting condition--but is sensitive to the precise curvature.  For this reason, the discretization needs to give it enough precision or the $g(t)$ can get distorted; (b) the majority of the curvature is close to the $z=0$ barrier, after which the function rapidly becomes constant; (c) the artificial boundary at $\bar{z}$ introduces a lot of curvature right near the end.  If there are not enough grid points close to the $\bar{z}$, then the local curvature near $v(\bar{z},t)$ effects a larger part of the whole distribution; and (d) since the expectation in \cref{eq:discretized-simple-vm} is taken over a heavy-tailed distribution, and is essential for solving the endogenous $g(t)$, truncations can have a significant bias if $\bar{z}$ is too small.  In particular, if you change the $\theta$ radically or conditions which lead to large changes in $g(t)$, you should verify that the analytical and numerical steady states do not become too different.}
	\item Identify an industrial-strength DAE solver (e.g. \url{http://docs.juliadiffeq.org/latest/tutorials/dae_example.html}).  For these, you give a an operator in the form of a stacked system of ODEs and algebraic equations, and then flag the algebraic ones for the solver.
	\item Find for the time $T$ steady state as $v(z,T)$ and $g(T)$ from \cref{eq:discretized-simple-stationary,eq:discretized-simple-vm-stationary} as the \textit{initial condition}, for working backwards in time.\footnote{While we have an analytical solution in this specific case, it is better to use the numerical solution for the steady-state since it the direct steady-state of the DAE for a given grid.} 
	\item Setup a function for the \cref{eq:discretized-simple,eq:discretized-simple-vm} tagging the last equation as an algebraic one.
	\item Solve the model.  To give a sense of the scale here, we have a system of roughly 2000-3000 ODEs for the full model, along with the single algebraic equation for the value matching condition.  For a DAE solver, this is at most a medium-sized problem.
\end{itemize}

This approach to solving transition dynamics seems to be generally applicable:\footnote{In fact, we suspect that this approach to be extremely fast and robust for most models.  Part of the difficulty in solving our setup is that models with endogenously determined growth rates always have peculiarities which lead extra sensitivity in numerical solutions.} (1) use a spatial discretization to turn the PDEs into a system of ODEs; (2) add any equilibrium constraints on the value functions or distributions as algebraic equations, using quadrature to convert any integrals into linear operators; (3) stack both to create a DAE system, and then use a high-performance solver.  A more general piece of advice for these is for economists to exploit high-performance ODE solvers with flexibility for various time-stepping methods rather than building their own.

\section{Full Growth Model with Transition Dynamics}
The fundamental differences between solving a full model of transition dynamics and that in the simple model are the following:
\begin{itemize}
	\item The $\pi(z,t)$ and $x(t)$ come from static equilibrium conditions given the trade-structure of the paper and the number of active local varieties, $\Omega(t)$, rather than being given exogenously
	\item The interest rate $r(t)$ is no longer given exogenously, but needs to be found in equilibrium.  Luckily, this is forward looking and can be solved in the current structure with only minor changes since the transition dynamics are being solved backwards
	\item The number of varieties $\Omega(t)$ is endogenously determined for trade shocks, and may change slowly according to profit maximizing and income smoothing incentives.
\end{itemize}

\paragraph{General Algorithm}
Of these, the only significant change is that the $\Omega(t)$ must be solved separately since the entry decision is dynamic.  Furthermore, since it begins with a stock $\Omega(0)$, and is forward looking, we cannot simply add it as a further algebraic equation.  To solve the equilibrium, we
\begin{enumerate}
	\item Guess a path for $\Omega(t)$ where we know $\Omega(0)$ and can calculate $\Omega(T)$ from the steady-state.
	\item Solve the underlying DAE using the ``exogenous'' $\Omega(t)$ using the same algorithm as the simple model.  The $\pi(t,z)$ is calculated from static equilibrium conditions and the exogenous $\Omega(t)$ in the solution.
	\item Calculate the residuals of the entry decision to determine the optimality of $\Omega(t)$
	\item Update the guess on $\Omega(t)$ until the residuals are minimized
\end{enumerate}

\paragraph{Transition Dynamics Experiment}

Assume $\delta > 0$.  This trade liberalization experiment will involve a one-time unanticipated decrease in $d$ as the trade liberalization.  We will calculate the two steady states and examine the transition dynamics.

In order to solve the dynamic problem in, we need to calculate $\tilde{\rho}(t), \pi_{\min}(t),\hat{z}(t),$ etc  as a function of $g(t), \Omega(t),$ and parameters.  As a simplification, we will assume that the cost of adoption is in labor, i.e. $\eta = 0$, so that $x(t) = \zeta$ for all $t$ from (PTW H.11)\footnote{Otherwise, there is an addition system of implicit equations to solve.}  %We also assume $\log$ utility, so that $\gamma = 1$.

\subsection{Number of Varieties and Entry in Transition}

Define $E(t)$ such that the \textbf{gross} entry flow is $E(t)\Omega(t)$.  Since the \textbf{gross} exit flow is $\delta \Omega(t)$, then the differential equation for $\Omega(t)$ comes from the net flows,
\begin{align} \label{eq:E-defined-by-Omega}
	\D[t] \Omega(t) &= \left(E(t) - \delta \right)\Omega(t)\\
\intertext{Rearrange,}
E(t) &\equiv \delta + \D[t]\log \Omega(t)
\end{align}
Therefore, in the steady-state we must have $E(t) = \delta$.

\subsection{Differential Equations}\label{sec:full-ODE}
The dynamic set of differential equations (rescaled) is derived in \cref{sec:full-model-derivations}.
\begin{align}
%	\tilde{\rho}(t) v(z,t) &= \pi(z,t) + (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z]v(z,t) + \frac{\upsilon^2}{2}\D[zz]v(z,t) + \D[t]v(z,t)\\
%	\D[t]v(z,t) &= \left(\tilde{\rho}(t)  - (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z] - \frac{\upsilon^2}{2}\D[zz]\right)v(z,t) - \pi(z,t) \\
	\D[t]v(z,t) &= A(t)v(z,t) - \pi(z,t) \\
	A(t) &\equiv \tilde{\rho}(t)  - (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z] - \frac{\upsilon^2}{2}\D[zz]\\
	v(0,t) &= \int_{0}^{\bar{z}}v(z,t) \frac{e^{\sigma - 1}F'(z)}{F(\bar{z})} \diff z - \zeta\\
	0 &= (\sigma - 1)v(0,t) + \D[z]v(0,t)\\
	0 &= (\sigma - 1)v(\bar{z},t) + \D[z]v(\bar{z},t)
\end{align}




\subsection{Dynamic Equations and Discretization}
To discretize \cref{sec:full-ODE}, define the interior operator, in a way similar to \cref{eq:A-def-simple}
\begin{align}
	A(t) &\equiv \tilde{\rho}(t) I - (\mu - g(t) + (\sigma - 1)\upsilon^2) L^{-}_1 - \frac{\upsilon^2}{2} L_2\label{eq:A-def-full}
	\end{align}
Discretize this and implement the boundary conditions in the discretized operator, as before, to get the system of ODEs,
\begin{align}
	v'(t) &= A(t) v(t) - \pi(t)
\end{align}

The three variables required in the DAE are $g(t), \hat{z}(t),$ and $\Omega(t)$.\footnote{Note: the $\hat{z}(t)$ \textbf{has no log} taken of it, unlike the $z$.  Hence, to see if a firm exports, we need to check if $z \geq \log(\hat{z}(t))$.  Furthermore, it means that the $\hat{z}$ has a minimum value of $1$.}  The \cref{eq:normalized-vm-summary-rescaled} value matching equation uses the same discretization approach as in the simple example (combining everything into the weights $\omega$, with the truncated exponential distribution, etc.) to discretize as
\begin{align}
	0 &= v_1(t) - \omega \cdot v(t) + \zeta
\end{align}

The export threshold equation is
\begin{align}
	0&=\hat{z}^{\sigma-1}-  \kappa d^{\sigma - 1} \bar{\pi}_{\min}(t)^{-1}
\end{align}

From \cref{sec:free-entry}, we see that
\begin{align}
	v_1(t) -  \zeta \frac{1-\chi}{\chi} &\leq 0,\, = \text{ if } E(t) > 0
\end{align}


\subsection{Static Calculations and Definitions}
Given the current $g$ and $\hat{z}$, the following definitions calculated at every time period, in the following rough order within the function.\footnote{See \cref{sec:derive-interest-rates} for a derivation of the interest rates, \cref{sec:full-rescaling} for a derivation of the normalized profits, and (PTW.H.2, H.7, H.8, )}.
\begin{align}
	S(t) &\equiv \theta \left( g(t) - \mu - \theta\frac{\upsilon^2}{2}\right)\\
	1 - \tilde{L}(t) &\equiv 1 - \Omega(t)\left((N -1)\hat{z}^{-\theta}\kappa + \zeta \left(S(t) + E(t)/\chi \right)\right)\\
	\bar{z}(t)^{\sigma - 1}&\equiv \Omega(t)
\frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{1-\sigma}\hat{z}^{\sigma - 1 -\theta} \right)\\
	\bar{\pi}_{\min}(t) &\equiv \frac{1-\tilde{L}(t)}{(\sigma-1)\bar{z}(t)^{\sigma-1}}\\
	\pi(z,t) &\equiv \bar{\pi}_{\min}(t)\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa e^{-(\sigma - 1)z}\indicator{z \geq \log(\hat{z}(t))}\\
	\tilde{\rho}(t) &\equiv \rho+ \delta + \D[t]\log\left(1 - \tilde{L}(t)\right) - (\sigma - 1)\left(\mu - g(t) + (\sigma - 1)\frac{\upsilon^2}{2} \right)
\end{align}
To calculate the $\D[t]\log\left(1 - \tilde{L}(t)\right)$ you need to store the ``future'' $\left(1 - \tilde{L}(t)\right)$ and $t$ values in the last adaptive timestep, and then use forward first-differences with it based on the current value


\paragraph{Final Calculations}
Some additional calculations useful for analyzing the model, but not required for the calculation are
\begin{align}
	\lambda_{ii}(t) &= \frac{1}{1 + (N-1)\hat{z}(t)^{\sigma-1-\theta}d^{1-\sigma}}\label{eq:lambda-ii-t-summary}\\
c &= (1 - \tilde{L})\bar{z} \label{eq:c-summary}\\
\log M(t) &= \int_0^t g(s)\diff s\label{eq:log-M-summary}\\
U(t) &= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \frac{e^{-\rho( T-t)}}{\rho^2}\left((1+\rho( T-t))g(T) + \rho\left(\log c(T) + \log M(T) \right) \right)\label{eq:U-dynamics-summary}
\end{align}


\newpage
\appendix
\makeatletter
\def\@seccntformat#1{Appendix\ \csname the#1\endcsname\quad}
\makeatother
\makeatletter
\def\@seccntformat#1{\csname Pref@#1\endcsname \csname the#1\endcsname\quad}
\def\Pref@section{Appendix~}
\makeatother
\numberwithin{equation}{section}
%\let\normalsize\small
%\small

\section{Spatial Discretization}\label{sec:discretization}
\subsection{Discretizing the State Space}
This will discretize space with backward differences in the first derivative, and central in space for the 2nd derivative.\footnote{Under a $g(t) > \gamma$ assumption (which may be a general requirement on parameter restrictions), the drift is negative, and the correct ``upwind'' finite difference scheme is always backwards.}  After discretizing the spatial dimension, we have a system of ODEs in time - which are solved using various time-stepping algorithms.

\begin{itemize}
	\item Define an irregular  grid $\set{z_i}_{i=1}^I$ with $z_1 = 0$ and $z_I = \bar{z}$ is a ``large'' number (keeping in mind that the effective number is $e^{\bar{z}}$).  After discretizing, we will denote the grid with the variable name, i.e. $z \equiv \set{z_i}_{i=1}^I$.
	\item Denote the distance between the grid points as the \textit{backwards} difference
	\begin{align}
	\Delta_{i,-} &\equiv z_i - z_{i-1},\, \text{for } i = 2,\ldots I\\
	\Delta_{i,+} &\equiv z_{i+1} - z_i,\, \text{for } i = 1,\ldots I-1
	\end{align}
	\item Assume $\Delta_{1, -} = \Delta_{1, +}$ and $\Delta_{I, +} = \Delta_{I, -}$, due to ghost points, $z_0$ and $z_{I+1}$ on both boundaries. (i.e., the distance to the ghost nodes are the same as the distance to the closest nodes).  Then define the vector of backwards and forwards first differences as
	\begin{align}
	\Delta_{-} &\equiv \begin{bmatrix} z_2 - z_1 \\
	\text{diff}(z)
	\end{bmatrix}\\
	\Delta_{+} &\equiv \begin{bmatrix} \text{diff}(z)\\
	z_I - z_{I-1}
	\end{bmatrix}
	\end{align}
	\item The grid on time $t \in [0,T]$ may be adaptive, and we will let the ODE solver handle the grid in order to use optimal time-stepping algorithms.
	\item Denote time-varying functions on the grid as a vector without the spatial dimension, i.e. 
	\begin{align}
	v(t) &\equiv \set{v(z_i, t)}_{i=1}^I\in\R^I\\
	\hat{\pi}(t) &\equiv	\hat{\pi}(z,t) \in \R^I
	\end{align}
\end{itemize}

\subsection{Discretization Operators}\label{sec:discretization-operators}
Summarizing the discretized differential operators subject to the boundary conditions.  Let $L_1^{-}$ be the discretized backwards first differences, subject to \cref{eq:new-BC1,eq:new-BC2} and $L_2$ be the discretized central differences subject to \cref{eq:new-BC1,eq:new-BC2}.

Then you can show that the following

\begin{align}
L_1^{-} &\equiv \begin{bmatrix} TODO \end{bmatrix}\\
L_2 &\equiv \begin{bmatrix}  TODO \end{bmatrix}
\end{align}

\subsection{Spatial Discretization}\label{sec:spatial-discretization}


\textbf{TODO:} This section should be replaced with the operator composition approach.  Note that the boundary conditions are homogenous, which is why the composition works wit.

\paragraph{Interior of $L$:}
To better understand the construction of $A$ and $b$, look at individual rows of $A$ with the ODE.\footnote{Note that the first derivative is not using central differences.  This is to ensure it is upwind, and hence that this is a monotone sequence, even for vanishing $\sigma$.
	
	\begin{align}
	\D[z]v(z_i, t_n) &\approx \frac{v_i^n - v_{i-1}^n}{\Delta_{i,-}}\label{eq:D-v-z}\\
	\intertext{And use non-uniform central differences for the 2nd derivative}
	\D[zz]v(z_i, t_n) &\approx \frac{\Delta_{i,-}v^n_{i+1} - (\Delta_{i,-}+\Delta_{i,+})v^n_i+\Delta_{i,+}v^n_{i-1}}{\frac1{2}(\Delta_{i,+}+\Delta_{i,-})\Delta_{i,-}\Delta_{i,+}}\label{eq:D-v-zz}
	\end{align}
	If the $z$ grid is uniform, the central differences should end up as just
	\begin{align}
	\D[zz]v(z_i, t_n) &\approx \frac{v_{i+1}^n - 2 v_i^n + v_{i-1}^n}{\Delta^2}\label{eq:D-v-zz-uniform}
	\end{align}
}

In the interior ($1 < i < I$), the discretization of finite difference operator is with drift $\mu_i$ split into upwind components is:
\begin{align}
\mathcal{A} v(z_i)
&= \underbrace{\left(-\frac{\mu_i^{-}}{\Delta_{i,-}} +\frac{\sigma_i^2}{\Delta_{i,-}(\Delta_{i,+}+\Delta_{i,-})}\right)}_{\equiv X_i}v_{i-1} + \underbrace{\left(\frac{\mu_i^{-}}{\Delta_{i,-}} - \frac{\mu_i^{+}}{\Delta_{i,+}}-\frac{\sigma_i^2}{\Delta_{i,-}\Delta_{i,+}}\right)}_{\equiv Y_i}v_i +\nonumber\\ &\underbrace{\left(\frac{\mu_i^{+}}{\Delta_{i,+}} + \frac{\sigma_i^2}{\Delta_{i,+}(\Delta_{i,+}+\Delta_{i,-})}\right)}_{\equiv Z_i}v_{i+1}\label{eq:A-collected-interior-with-nonuniform-grid}
\end{align}

\paragraph{Boundary Value at $x=0$:}
If the boundary value is $\xi v(0,t) + \D[z]v(0,t )= 0$, use the backward difference approximation $v'(z_i) \approx \frac{v_i-v_{i-1}}{\Delta_{i,-}}$.  Then substituting into the boundary condition we get
\begin{align}
0 = \xi v(0,t) + \D[z]v(0,t ) &\approx \xi v_1 + \frac{v_1-v_0}{\Delta_{1,-}}\\
\intertext{Rearrange, use $\Delta_{1,-} = \Delta_{1,+}$, and solve for $v_0$,}
v_0 &= (1 + \xi \Delta_{1,+})v_1\label{eq:rescaled-bc-sub}\\
\intertext{Now, take \cref{eq:A-collected-interior-with-nonuniform-grid}, and remember that given a $v_0$ the function is well defined under the assumption that $\Delta_{1,-} = \Delta_{1,+}$}
\mathcal{A} v(z_1) &\approx X_1 v_0 + Y_1 v_1 + Z_1 v_2
\intertext{Substitute in \cref{eq:rescaled-bc-sub} to get}
\mathcal{A} v(z_1) &\approx \left((1 + \xi \Delta_{1,+})X_1 + Y_1\right) v_1 + Z_1 v_2\label{eq:reflecting-left-nonuniform}
%\intertext{Substitute this into \cref{eq:A-collected-with-nonuniform-grid-left}}
% &\approx \left(\underbrace{\left(\frac{-\mu_1^{-}}{\Delta_{1,-}} +\frac{\sigma_1^2}{\Delta_{1,-}(\Delta_{1,+}+\Delta_{1,-})}\right)}_{\equiv X_1}(1+\Delta_{1,-}) + \underbrace{\left(\mu_1^{-} - \frac{\mu_1^{+}}{\Delta_{1,+}}-\frac{\sigma_1^2}{\Delta_{1,+}\Delta_{1,-}}\right)}_{\equiv Y_1}\right)v_1 + \nonumber\\
% & \underbrace{\left(\frac{\mu_1^{+}}{\Delta_{1,+}} + \frac{\sigma_1^2}{2 \Delta_{1,+}\Delta_{1,-}}\right)}_{\equiv Z_1}v_2\label{eq:reflecting-left-nonuniform}
\end{align}
So from \cref{eq:reflecting-left-nonuniform} the top left corner of $A$ matrix is now $\left((1 + \xi \Delta_{1,+})X_1 + Y_1\right)$.  Note that this nests the typical reflecting barrier since if the scaling is $e^{0} = 1$, then the corner, is $X_1 + Y_1$, matches the standard reflecting barrier without rescaling.

\paragraph{Boundary Value at $\bar{z}$}
If the boundary value is $\xi v(\bar{z},t) + \D[z]\tilde{\bar{z}}(0,t )= 0$, use the forward difference approximation $v'(z_i) \approx \frac{v_{i+1}-v_{i}}{\Delta_{i,+}}$.  Then substituting into the boundary condition we get
\begin{align}
0 = \xi v(\bar{z},t) + \D[z]v(\bar{z},t ) &\approx \xi v_I + \frac{v_{I+1}-v_I}{\Delta_{I,+}}\\
\intertext{Rearrange and solve for $v_0$ and use $\Delta_{I,+} = \Delta_{I,-}$,}
v_{I+1} &= (1 - \xi \Delta_{I,-}) v_I\label{eq:rescaled-bc-sub-right}\\
\intertext{Now, take \cref{eq:A-collected-interior-with-nonuniform-grid}, and remember that given a $ v_{I+1}$ the function is well defined under the assumption that $\Delta_{I,-} = \Delta_{I,+}$}
\mathcal{A}  v(z_I) &\approx X_1  v_{I-1} + Y_1  v_I + Z_1  v_{I+1}
\intertext{Substitute in \cref{eq:rescaled-bc-sub-right} to get}
\mathcal{A}  v(z_I) &\approx X_I  v_{I-1} + \left(Y_I + (1 - \xi \Delta_{I,-})Z_I\right)  v_I\label{eq:reflecting-right-nonuniform}
\end{align}
So from \cref{eq:reflecting-right-nonuniform} the bottom right corner of $A$ matrix is now $\left(Y_I + (1 - \xi \Delta_{I,-})Z_I\right)$.  Note that this nests the typical reflecting barrier since if the scaling is $e^{0} = 1$, then the corner, is $X_1 + Y_1$, matches the standard reflecting barrier without rescaling.

%Can remove if we think the above is correct
% \paragraph{Boundary Value at $\bar{z}$:}
% As $i=I$, given the ``ghost node'' $z_{I+1}$, and the assumption  $\Delta_{I,+} = \Delta_{I,-}$, from \cref{eq:A-collected-interior-with-nonuniform-grid}:
% \begin{align}
% \mathcal{A}   v(x_I)&\approx \left(-\frac{\mu_I^{-}}{\Delta_{I,-}} +\frac{\sigma_I^2}{2 \Delta_{I,-}^2}\right) v_{I-1} + \left(\frac{\mu_I^{-} - \mu_I^{+}}{\Delta_{I,-}}-\frac{\sigma_I^2}{\Delta_{I,-}^2}\right) v_I + \left(\frac{\mu_I^{+}}{\Delta_{I,-}} + \frac{\sigma_I^2}{2 \Delta_{I,-}^2}\right) v_{I+1}\\
% \intertext{For a reflecting barrier, the boundary value $v'(\bar{z}) \approx \frac{ v_{I+1}- v_I}{\Delta_{I,+}}+ v_{I} = 0, \implies  v_{I+1} = (1-\Delta_{I,+}) v_I$,}
% &\approx \underbrace{\left(-\frac{\mu_I^{-}}{\Delta_{I,-}} +\frac{\sigma_I^2}{\Delta_{I,-}(\Delta_{I,+}+\Delta_{I,-})}\right)}_{\equiv X_I}  v_{I-1}\nonumber\\
% &+ \left(\underbrace{\left(\frac{\mu_I^{-}}{\Delta_{I,-}} - \frac{\mu_I^{+}}{\Delta_{I,+}}-\frac{\sigma_I^2}{\Delta_{I,-}\Delta_{I,+}}\right)}_{\equiv Y_I} + \underbrace{\left(\frac{\mu_I^{+}}{\Delta_{I,+}} + \frac{\sigma_I^2}{\Delta_{I,+}(\Delta_{I,+}+\Delta_{I,-})}\right)}_{\equiv Z_I}(1-\Delta_{I,+}) \right)  v_I \label{eq:reflecting-right-nonuniform}
% \end{align}

\paragraph{Discretization Operator:} Apply the boundary conditions at the corner of discretization matrix:

\begin{align}
A &\equiv \begin{bmatrix}
X_1^n(1+\xi\Delta_{1,+})+Y_1^n & Z_1^n & 0 & \ldots & \ldots & \ldots & 0\\
X^n_2 & Y^n_2 & Z^n_2 & 0 & 0 & \ldots & 0\\
\vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots\\
0 & 0 & 0 & \ldots & X^n_{I-1} & Y^n_{I-1} & Z^n_{I-1}\\
0 & \ldots & \ldots & \ldots & 0 & X_I^n & Y_I^n+Z_I^n(1-\xi\Delta_{I,-})
\end{bmatrix}\in\R^{I\times I}\label{eq:A-n}
\end{align}

\section{Derivations for Simple Model}\label{sec:simple-derivation}
\subsection{Equations Prior to Rescaling}

From the technical appendix of Benhabib, Perla, and Tonetti (2019) (but renaming the $v$ function to $\hat{v}$ here), assume an exogenously given $\hat{\pi}(z,t)$ and $x(t)$ function.  We will only look at examples where $F(z) = 1 - e^{-\theta z}$ for all $t$.
\begin{align}
(r - g(t)) \hat{v}(z,t) &= \hat{\pi}(z,t) + (\mu- g(t)) \D[z] \hat{v}(z,t) + \frac{\upsilon^2}{2} \D[zz] \hat{v}(z,t) + \D[t]\hat{v}(z,t)\label{eq:bellman-GBM-dynamic}	\\
\hat{v}(0,t) &= \int_{0}^{\infty} \hat{v}(z,t) F'(z)\diff z - x(t)\label{eq:vm-GBM-dynamic}\\
\D[z]\hat{v}(0,t) &= 0\label{eq:sp-GBM-dynamic}
\end{align}

A solution to this problem is a $g(t)$ and $\hat{v}(z,t)$ that fulfills the above equations for all $t\in[0,T]$ and $z\in[0,\infty)$.  While not listed above, in practice another boundary condition (e.g. transversality) is used to ensure that \cref{eq:bellman-GBM-dynamic} can be solved. We us, a reflecting barrier at a ``large'' $\bar{z}$ converges to the correct solution.  Use the boundary value\footnote{Keep in mind that this is just a step in the numerical solution, rather than introducing a true reflecting barrier.  We will need to verify that it does not introduce issues by verifying the numeric solution matches the closed form solution for large $\bar{z}$ and compare to the analytic equation for external validity.  Also note that if $\upsilon = 0$, due to the upwind procedure this boundary value would be unnecessary and/or drop out of the solution.}
	\begin{align}
	\D[z]\hat{v}(\bar{z},t) &= 0\label{eq:reflecting-GBM-dynamic}
	\end{align}


\subsection{Change of Variables to Normalize and Rescale}\label{eq:simple-rescale}
Solving \cref{eq:bellman-GBM-dynamic} for $\hat{v}(z,t)$ is problematic since the scale goes from approximatively $1$ to $e^{\bar{z}}$, which is very large for a high $\bar{z}$.  To make the solution more stable, we rescale the equation.  Choose some $\xi \geq 0$ for convenience and to ensure stability and let
\begin{align}
	v(z,t) &\equiv e^{-\xi z}\hat{v}(z,t) = e^{-\xi z}\frac{V(e^z M(t),t)}{M(t)}\\
	\intertext{Differentiate and reorganize this expression to yield}
	\D[z]\hat{v}(z,t) &= e^{\xi z}\left(\xi v(z,t) + \D[z]v(z,t) \right)\\
	\D[zz]\hat{v}(z,t) &= e^{\xi z}\left(\xi^{2} v(z,t) + 2 \xi\D[z]v(z,t) + \D[zz]v(z,t)  \right)\\
	\D[t]\hat{v}(z,t) &= e^{\xi z} \D[t]v(z,t)
\end{align}
Define $\pi(z,t) = e^{-\xi z}\hat{\pi}(z,t)$ so that if $\hat{\pi}(z,t) = e^{\xi z}$ then $\pi(z,t) = 1$.  Substitute into \cref{eq:bellman-GBM-dynamic}, divide by $e^{\xi z}$ and simplify,

\begin{align}
	\left(r - g(t)- \xi(\mu-g(t)) - \frac{\upsilon^2}{2}\xi^2\right)  v(z,t) &= \pi(z,t) + (\mu+ \upsilon^2\xi - g(t)) \D[z]v(z,t) \nonumber \\ &+ \frac{\upsilon^2}{2} \D[zz]v(z,t) + \D[t]v(z,t)  \label{eq:bellman-GBM-dynamic-normalized}
\end{align}

Now, substitute into the boundary conditions \cref{eq:sp-GBM-dynamic,eq:reflecting-GBM-dynamic} to find,
\begin{align}
	\xi v(0,t) + \D[z]v(0,t ) &= 0\label{eq:new-BC1}\\
	\xi v(\bar{z},t) + \D[z]v(\bar{z},t) &= 0\label{eq:new-BC2}
\end{align}
Finally, in the value matching condition, $\hat{v}(0,t) = e^{0} v(0,t)$ where if the $F'(z) = \theta e^{-\theta z}$ then,
\begin{align}
	 v(0,t) &= \int_{0}^{\infty}  v(z,t) \left(e^{\xi z} F'(z)\right) \diff z - x(t)\label{eq:vm-GBM-dynamic-normalized-not-truncated}
\end{align}
However, for the numerical approximation with the artificial boundary at $\bar{z}$, we need to use a truncated distribution for $F(z)$.  Since we have take the $F(z)$ with support from $[0,\infty)$, and we truncate at $\bar{z} = \bar{z}$ then the equation in \cref{eq:vm-GBM-dynamic-normalized-not-truncated} to work with is,
\begin{align}
	 v(0,t) &= \int_{0}^{\bar{z}}  v(z,t) \left(e^{\xi z} \frac{F'(z)}{F(\bar{z})}\right) \diff z - x(t)\label{eq:vm-GBM-dynamic-normalized}
\end{align}


\subsection{Quadrature}\label{sec:quadrature}
With the discretized grid, the integral in \cref{eq:vm-GBM-dynamic-normalized} will be calculated with some quadrature rules.\footnote{An issue here is that the support of the integral is infinite, but the finite differences go to $z_I$.  While not ideal, since $F'(z_I)\to 0$ rapidly, the Trapezoidal rule should be a  reasonable approximation.}  Most generally, let the quadrature rule weights be $\bar{\omega} \in \R^I$ where for some $q(z)$ and $q \equiv \set{q(z_i)}_{i=1}^I$,
\begin{align}
\int_0^{\bar{z}} q(z) \diff z &\approx \bar{\omega} \cdot q
\intertext{To derive the non-uniform trapezoidal rules for an arbitrary $q$ function,}
\int_{z_1}^{z_I} q(z)\diff z &\approx \frac1{2}\sum_{i=1}^{I-1}(z_{i+1}-z_i)(q(z_i) + q(z_{i+1}))\\
&= \frac1{2}\left(\Delta_{1,+}q(z_1) + (\Delta_{1,+} + \Delta_{2,+})q(z_2) + \ldots (\Delta_{I-2,+} + \Delta_{I-1,+})q(z_{I-1})+\Delta_{I-1,+}q(z_I)\right)
\intertext{If we set $\Delta_{1,-} = 0$ and $\Delta_{I,+} = 0$ then, (Note different than other use of ghost nodes in derivatives, though not sure they enter equations in those other cases)}
\int_{z_1}^{z_I} q(z)\diff z &\approx \bar{\omega}\cdot q\\
\intertext{where,}
\bar{\omega}&\equiv \frac1{2}(\Delta_{-} + \Delta_{+})
\end{align}


Moving to the specific integral in \cref{eq:vm-GBM-dynamic-normalized}, define the $\omega$ weights to combine the $\bar{\omega}$ and the $\left(e^{\xi z} \frac{F'(z)}{F(\bar{z})}\right)$ term so that
\begin{align}
\omega_i &\equiv \bar{\omega}_i e^{\xi z_i}\frac{F'(z_i)}{F(\bar{z})}\\
\intertext{Then with the discretized vector $v(t) \in \R^I$, the integral in \cref{eq:vm-GBM-dynamic-normalized} becomes,}
v_1(t) &= \omega \cdot v(t) - x(t)
\end{align}

\section{Derivations of Full Model}\label{sec:full-model-derivations}

\subsection{Static Objects and Algebraic Solution}\label{sec:full-algebraic-solution}

Note that we have the following static calculations from the main paper (eqns H.1 - H.11)

\begin{align}
	F(z) &= 1 - z^{-\theta} \\
	S &= \theta \left(g - \mu - \theta \frac{\upsilon^2}{2}\right) \\
	\nu &= \frac{\mu - g}{\upsilon^2} + \sqrt{\left(\frac{g - \mu}{\upsilon^2}\right)^2 + \frac{\upsilon^2}{2}} \\
	a &= \frac{1}{r - g - (\sigma - 1)(\mu - g  + (\sigma - 1)\upsilon^2/2)} \\
	b &= (1 - a(r-g))d^{1-\sigma}\hat{z}^{\nu + \sigma -1} \\
	r &= \rho + \gamma g + \delta \\
	\tilde{L} &= \Omega [(N-1)(1 - F(\hat{z}))\kappa + (1-\eta)\zeta(S + \delta/\chi)] \\
	\bar{z} &= [\Omega(\mathbb{E}[z^{\sigma - 1}] + (N-1)(1 - F(\hat{z}))d^{1 - \sigma}\mathbb{E}[z^{\sigma - 1}|z > \hat{z}])]^{1/(\sigma - 1)} \\
	\hat{z} &= d \left(\frac{\kappa}{\bar{\pi}_{\textup{min}}}\right)^{\frac{1}{\sigma - 1}} \\
	w &= \frac{1}{\bar{\sigma}}\bar{z} \\
	x &= \zeta(1 - \eta + \eta \Theta / w) \\
		c &= (1 - \tilde{L})\bar{z} \\
		\bar{U} &=
	\begin{cases}
	\frac{\rho (\log(c) + gt ) + g}{\rho^2}, & \gamma = 1 \\
	\frac{1}{1-\gamma} \frac{c^{1 - \gamma}}{\rho + (\gamma - 1)g} & \text{otherwise}
	\end{cases} 
\end{align}

This gives us a system of three nonlinear equations to solve:

		\begin{align}
		\frac{x}{\bar{\pi}_{\min}} &=  a \frac{\chi}{1-\chi}\frac{\sigma + \nu - 1}{\nu} , \\
		1 + \frac{\sigma - 1}{\nu} &= {\scriptstyle \frac{\frac{\nu  (n-1) (\theta -\sigma +1) \left(d^{1-\sigma } (\theta +\nu ) \hat{z}^{-\theta +\sigma -1}-b \theta  \hat{z}^{-\theta -\nu }\right)}{a (g-r)}+\theta  \left(\nu  (n-1) d^{1-\sigma } (\theta +\nu ) \hat{z}^{-\theta +\sigma -1}+(\nu +\sigma -1) (\theta +\nu -\sigma +1)\right)}{\nu  (\theta +\nu ) (\theta -\sigma +1)} -  \frac{\chi}{1-\chi}\frac{\sigma + \nu - 1}{\nu}} , \\
		\bar{\pi}_{\min} &= \tfrac{1 - \tilde{L}}{(\sigma - 1) \bar{z}^{\sigma - 1}}.
		\end{align}

\subsection{Normalization and Rescaling}\label{sec:full-rescaling}
Note that unlike the PTW paper we have $z \equiv \log(Z/M(t))$ throughout these notes.  The value is normalized as $\hat{v}(z,t) = \frac{V(e^z M(t),t)}{M(t)w(t)}$.  With this,
\begin{align}
V(Z,t) &:= w(t) M(t) \hat{v}(t, \log(Z/M(t)))\label{eq:V-norm}\\
\intertext{Differentiate \cref{eq:V-norm} with respect to $t$, divide by $w(t)M(t)$, and use the definitions $z := \log(Z/M(t)), g(t):= M'(t)/M(t)$ and $g_w(t) := W'(t)/W(t)$}
\frac{1}{w(t) M(t)}\D[t]V(Z,t) &= \left(g(t) + g_w(t)\right)\hat{v}(z,t) - g(t)\D[z]\hat{v}(z,t) + \D[t]\hat{v}(z,t) \label{eq:dV-dt}\\
\intertext{Similarly differentiate \cref{eq:V-norm} with respect to $Z$,}
\frac{1}{w(t) M(t)}\D[Z]V(Z,t) &= \frac{1}{Z}\D[z]\hat{v}(z,t)\label{eq:dV-dZ}\\
\frac{1}{w(t) M(t)}\D[ZZ]V(Z,t) &= \frac{1}{Z^2}\left(\D[zz]\hat{v}(z,t)-\D[z]\hat{v}(z,t)\right)\label{eq:dV-dZZ}
\end{align}
Take the unnormalized Bellman equation from the paper, repeated below,
\begin{align}
r(t) V(Z,t) &=  \Pi(Z,t)+ \left(\mu + \frac{\upsilon^2}{2}\right) Z\, \D[Z]V(Z,t)+ \frac{\upsilon^2}{2} Z^2 \D[ZZ]V(Z,t) +  \D[t]V(Z,t), \label{ap-eq:bellman-deterministic-prenorm}
\intertext{Use $\pi(z,t) \equiv \frac{\Pi(Z,t)}{w(t)M(t)}$ with the new $z$, divide \cref{ap-eq:bellman-deterministic-prenorm} $w(t)M(t)$ and then use \cref{eq:dV-dt,eq:dV-dZ,eq:dV-dZZ} to find,}
(r(t) - g(t) - g_w(t))\hat{v}(z,t) &= \pi(z,t) + (\mu - g(t))\D[z]\hat{v}(z,t) + \frac{\upsilon^2}{2}\D[zz]\hat{v}(z,t) + \D[t]\hat{v}(z,t)\label{eq:normalized-bellman}
\intertext{The smooth pasting condition, $\D[Z]V(M(t),t) = 0$ becomes}
\D[z]\hat{v}(0,t) &= 0\label{eq:normalized-sp}
\intertext{Take the value matching condition from the paper and divide by $M(t)w(t)$,}
\frac{{V}(M(t),t)}{M(t)w(t)} &= \int_{M(t)}^{\infty}\frac{{V}(Z,t)}{M(t)w(t)} \phi(Z,t) \diff Z - \frac{X(t)}{M(t)w(t)}
\intertext{Substitute for $\hat{v}(z,t)$ and $x(t) \equiv \frac{X(t)}{M(t)w(t)}$,}
\hat{v}(0,t) &= \int_{0}^{\infty}\hat{v}(\log(Z/M(t)),t) \phi(Z,t) \diff Z - x(t)
\intertext{With a change of variables in the integral to  $z = \log(Z/M(t))$,}
\hat{v}(0,t) &= \int_{0}^{\infty}\hat{v}(z,t) f(z,t) \diff z - x(t)\label{eq:normalized-vm}
\intertext{We will only solve versions of the model starting from a stationary Pareto distribution with tail index $\theta$ and minimum $M(t)$, so if $\phi(Z,t) = \theta M(t)^{\theta}Z^{-(1+\theta)}$ then}
f(z) &= \theta e^{-\theta z}\label{eq:f-stationary}
\end{align}
for all $t$.  It can be proven that this will be maintained by the KFE in the setup for any $g(t)$ sequence.

While this transformation could be done all at once, we will base it off of the previous section for easier comparison.  Define the following
\begin{align}
v(z,t) &\equiv e^{-(\sigma - 1)z}\hat{v}(z,t)\label{eq:v-tilde}\\
\pi(z,t) &\equiv e^{-(\sigma - 1)z}\hat{\pi}(z,t)
\end{align}
Rearrange and differentiate \cref{eq:v-tilde},
\begin{align}
\D[t]\hat{v}(z,t) &= e^{(\sigma - 1)z} \D[t]v(z,t)\label{eq:v-tilde-dt}\\
\D[z]\hat{v}(z,t) &= e^{(\sigma - 1)z}\left((\sigma - 1) v(z,t) + \D[z]v(z,t) \right)\label{eq:v-tilde-dz}\\
\D[zz]\hat{v}(z,t) &= e^{(\sigma - 1)z}\left((\sigma - 1)^2 v(z,t) + 2(\sigma - 1)\D[z]v(z,t) + \D[zz]v(z,t)\right)\label{eq:v-tilde-dzz}\\
\intertext{And at the adoption threshold, from \cref{eq:v-tilde-dz}}
\D[z]\hat{v}(0,t) &= (\sigma - 1) v(0,t) + \D[z]v(0,t)\label{eq:vt-0-dz}
\end{align}

To use these substitutions, start with \cref{eq:normalized-vm} and use the definition of $f(z)$,
\begin{align}
v(0,t) &= \theta \int_{0}^{\infty} v(z,t) e^{(-\theta + \sigma - 1)z} \diff z - x(t)\label{eq:normalized-vm-summary-rescaled}\\
\intertext{Combine \cref{eq:normalized-sp,eq:vt-0-dz} to get}
0 &= (\sigma - 1) v(0,t) + \D[z]v(0,t)\label{eq:normalized-sp-summary-rescaled}
\intertext{Finally, substitute all of the derivatives into \cref{eq:normalized-bellman} and divide by $e^{(\sigma - 1)z}$}
\tilde{\rho}(t)  v(z,t) &= \pi(z,t) + (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z]v(z,t) + \frac{\upsilon^2}{2}\D[zz]v(z,t) + \D[t]v(z,t)
\intertext{where,}
\tilde{\rho}(t) &\equiv  r(t) - g(t) - g_w(t) - (\sigma - 1)\left(\mu - g(t) + (\sigma - 1)\frac{\upsilon^2}{2} \right)\label{eq:rhot}
\end{align}

\noindent From (PTW.C.26 to C.28) using the $z\equiv\log(Z/M(t))$ definition,
\begin{align}
	\hat{\pi}(z,t) &= \pi_{\min}(t) e^{(\sigma - 1)z}\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa\indicator{z \geq \log(\hat{z}(t))}\label{eq:pi-z-t-summary}
\intertext{Multiply by $e^{-(\sigma - 1)z}$ to get,}
\pi(z,t) &\equiv \bar{\pi}_{\min}(t)\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa e^{-(\sigma - 1)z}\indicator{z \geq \log(\hat{z}(t))}
\end{align}




%\subsection{Summarizing Normalized Equations}\label{sec:normalized-equations}
%Take as given $g(t),\pi_{\min}(t),\hat{z}(t), x(t)$, and $\tilde{r}(t)$(alternatively $g_w(t)$ and $r(t)$).  Then, the following equations must be fulfilled for all $t$ and  $z$
%\begin{align}
%\tilde{r}(t) \equiv & r(t) - g(t) - g_w(t)\label{eq:r-tilde-summary}\\
%f(z) &= \theta e^{-\theta z}\label{eq:f-stationary-summary}\\
%\tilde{r}(t) \hat{v}(z,t) &= \hat{\pi}(z,t) + (\mu - g(t))\D[z]\hat{v}(z,t) + \frac{\upsilon^2}{2}\D[zz]\hat{v}(z,t) + \D[t]\hat{v}(z,t)\label{eq:normalized-bellman-summary}\\
%\D[z]\hat{v}(0,t) &= 0\label{eq:normalized-sp-summary}\\
%\hat{v}(0,t) &= \int_{0}^{\infty}\hat{v}(z,t) f(z) \diff z - x(t)\label{eq:normalized-vm-summary}\\
%\end{align}



\subsection{Free-entry Condition}\label{sec:free-entry}
To determine the $E(t)$ function, we need the free entry complementarity condition to hold.  Note that (PTW D.19) actually holds for any $t$ as well, and does not require the stationary solution.  From (PTW D.19) and using $v(t,0) = \hat{v}(t,0)$, we see that if $E(t) > 0$ that,
\begin{align}
v(t,0) &= \zeta \frac{1-\chi}{\chi}
\intertext{In the case that there is no entry, and $E(t) = 0$ for some $t$, from (D.18)}
v(0,t) &< \zeta \frac{1-\chi}{\chi}
\end{align}

\subsection{Derivation of Rates of Change and Interest Rates}\label{sec:derive-interest-rates}
Since consumption is $C(t) := c(t) M(t)$, take logs and differentiate to get,
\begin{align}
\D[t]\log C(t) &= g(t) + g_c(t)
\intertext{With a CRRA parameter of $\gamma \geq 0$, the interest rate rate faced by a firm is,}
r(t) &= \rho + \delta + \gamma \D[t]\log C(t)\\
&= \rho+ \delta + \gamma(g_c(t)+ g(t))\label{eq:r-def}
\end{align}

\noindent This can be simplified in some cases.  From the PTW (C.34), for $\eta = 0$,
 \begin{align}
 \frac{c(t)}{w(t)}&\propto 1 - \tilde{L}(t)
 \intertext{Taking the log and differentiating,}
g_c(t) - g_w(t) &= \D[t]\log\left(1 - \tilde{L}(t)\right)\label{eq:g-c-w-diff}
\intertext{Define,}
\tilde{r}(t) &\equiv r(t) - g(t) - g_w(t)\\
\intertext{From \cref{eq:r-def}}
&= \rho + \delta + \gamma(g_c(t)+ g(t)) - g(t) - g_w(t)\\
&= \rho + \delta + (g_c(t) - g_w(t)) + (\gamma - 1)(g_c(t) + g(t))\\
\intertext{From \cref{eq:g-c-w-diff}}
&= \rho + \delta + \D[t]\log\left(1 - \tilde{L}(t)\right) + (\gamma - 1)(g_c(t) + g(t))\\
\intertext{And in the $\log$ utility case with $\gamma = 1$, the last term drops, so that we have,}
 \tilde{r}(t) &=  \rho+ \delta + \D[t]\log\left(1 - \tilde{L}(t)\right)\label{eq:tilde-r-L}
 \end{align}


 \subsection{Derivations of Cutoffs and Profits}
 From (PTW H.11), the adoption cost relative to wages remains constant throughout the transition (i.e. assumed $\eta = 0$):
 \begin{align}
 x(t) &= \zeta\label{eq:x-zeta}
 \intertext{For the components of aggregate profits, we need to find $\pi_{\min}(t)$. In order to solve for the static $\hat{z}(t)$ condition, we will leave it as a variable in the equations.  Start with (PTW C.26)}
 \pi_{\min}(t) &= \frac{1-\tilde{L}(t)}{(\sigma-1)\bar{z}(t)^{\sigma-1}}\label{eq:pi-min-def}\\
 \intertext{From (PTW C.19), along the transition dynamics $E(t)$ is left general}
 \tilde{L}(t) &=\Omega(t)\left[(N-1)(1-F(\hat{z}(t)))\kappa + \zeta \left( S(t) + E(t)/\chi\right)\right]\label{eq:L-tilde-sub}\\
 &=\Omega(t)\left((N -1)\hat{z}^{-\theta}\kappa + \zeta \left(S(t) + E(t)/\chi \right)\right)\\
 \intertext{From (PTW C.10)}
 \bar{z}(t) &= \left[\Omega(t)\left(\expec{z^{\sigma - 1}} + (N-1)(1-F(\hat{z}(t)))d^{1-\sigma}\condexpec{z^{\sigma - 1}}{z > \hat{z}(t)}\right)\right]^{\frac{1}{\sigma - 1}}\\
 &= \left[\Omega(t)
 \frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{-\theta}\left(\frac{\hat{z}}{d} \right)^{\sigma - 1 -\theta} \right)\right]^{\frac{1}{\sigma - 1}}\label{eq:z-bar-sub}\\
 \end{align}

 Hence,
 \begin{align}
 \bar{z}(t)^{\sigma - 1}&= \Omega(t)
 \frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{1-\sigma}\hat{z}^{\sigma - 1 -\theta} \right)\label{eq:z-bar-sub-power}\\
 \intertext{Use (PTW C.29)}
 \hat{z}(t)&= d \left(\tfrac{\kappa}{\bar{\pi}_{\min}(t)} \right)^{\frac{1}{\sigma - 1}}\label{eq:z-hat-def}
\intertext{Reorganize \cref{eq:z-hat-def} to find an implicit equation in $\hat{z}$ at every $t$,}
 0&=\hat{z}^{\sigma-1}-  \kappa d^{\sigma - 1} \bar{\pi}_{\min}(t)^{-1}\label{eq:z-hat-power}
 \end{align}
 Note that \cref{eq:z-hat-power} provides an implicit equation in $\hat{z}(t)$ given an exogenous $\Omega(t)$ and $g(t)$ and \cref{eq:L-tilde-sub}, and can be solved separately for each $t$.  From the implicit $\hat{z}(t)$, calculate the home trade share through (PTW C.47),
 \begin{align}
 \lambda_{ii}(t) &= \frac{1}{1 + (N-1)\hat{z}(t)^{\sigma-1-\theta}d^{1-\sigma}}\label{eq:lambda-ii-t}\\
\intertext{Use (PTW C.49) to calculate,}
 \bar{\pi}_{\min}(t) &= \frac{(N-1) \hat z(t) ^{-\theta}\kappa}{1-\lambda_{ii}(t)} \label{eq:pi-bar-t}
 \end{align}

\subsection{Welfare Calculations}
Assume that there is a $T > 0$ such that the equilibrium reaches a steady state.   Given that $g(t) \equiv \D[t]\log M(t)$.  With this,
\begin{align}
M(t) &=M(0)\times\begin{cases}
\exp\left(\int_0^t g(s)\diff s \right) & \text{ if } 0 \leq t \leq T\\
\exp\left(\int_0^{T} g(s)\diff s  + (t - T)\bar{g} \right) & t \geq T
\end{cases}\label{eq:M-t-sol}
\intertext{Assume wlog that $M(0) = 1$, then,}
\log M(t) &= \int_0^t g(s)\diff s\label{eq:log-M}
\end{align}

\subsection*{Intermediate Objects}

Before proceeding, define the following intermediate objects (see Appendix H of PTW):

\begin{align}
	y &= (1 - \tilde{L})\bar{z} \\
	\lambda_{ii} &= \frac{1}{1 + (N-1)\hat{z}^{\sigma - 1 - \theta}d^{1-\sigma}} \\
	c &= (1 - \tilde{L})\bar{z} 
\end{align}


At the steady state, define $\bar{g}$ and $\bar{c}$ as the growth rate and consumption relative to real wages for $t \geq T$.  The consumer welfare can be calculated as from (PTW 1),
\begin{align}
U(t) &= \int_0^{\infty}e^{-\rho \tau}\log C(t+\tau)\diff \tau\\
&= \int_0^{\infty}e^{-\rho \tau}\log M(t+\tau) \diff \tau + \int_0^{\infty}e^{-\rho \tau}\log c(t+\tau)\diff \tau\label{eq:U-def}
\intertext{Given the convergence at time $T$, use \cref{eq:U-def} to split the welfare integral,}
U(t) &= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \int_{T-t}^{\infty}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau\\
\intertext{Note that $c(t)= \bar{c}$ for $t \geq T$,}
&= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \frac{e^{-\rho( T-t)}}{\rho^2}\left((1+\rho( T-t))\bar{g} + \rho\left(\log \bar{c} + \log M(T) \right) \right)\label{eq:U-dynamics}
%	\intertext{With \cref{eq:M-t-sol}}
%	&= \int_0^{T}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \frac{e^{-\rho( T-t)}}{\rho^2}\left((1+\rho( T-t))g(T) + \rho\left(\log \bar{c} + \log M(T) \right) \right)
\intertext{With (PTW G.31) and (PTW G.33) and \cref{eq:f-stationary-summary}}
c(t) &= \left(\frac{\theta}{1-\sigma+\theta}\right)^{\frac{1}{\sigma-1}}\left(1 - \tilde{L}(t)\right)\Omega(t)^{\frac{1}{\sigma - 1}} \lambda_{ii}(t)^{\frac{1}{1-\sigma}}\label{eq:c-def}
\end{align}

\subsection{Consumption Equivalent}
Note that we need to consider if $M(0) \neq 1$.  Modifiy \cref{eq:log-M}
\begin{align}
\log M(t) &= \log M(0) + \int_0^t g(s)\diff s\label{eq:log-M-notone}\\
\intertext{Hence, modifying \cref{eq:U-def} to get the welfare at time $0$ given a $M(0)$}
U(0; M(0)) &= \log M(0)\int_0^{\infty}e^{-\rho \tau} \diff \tau + \int_0^{\infty}e^{-\rho \tau}\left(\int_0^\tau g(s)\diff s\right)\diff \tau + \int_0^{\infty}e^{-\rho \tau}\log c(\tau)\diff \tau\label{eq:U-def-notone}
\end{align}
If we were in the steady state, then the second two terms are simply be the welfare if $M(0) = 1$, hence,
\begin{align}
U(0, M(0)) &= \frac{\log M(0)}{\rho} + U(0, 1)
\end{align}


Calculate the welfare at the steady state before the shock (which assumes a $M(0) = 1$) as define it as $U^{\text{old}}(0)$, then calculate from \cref{eq:U-dynamics} the welfare at time $0$ after the shock as just realized, and calculated as $U(0)$, then to find the indifference level of $M(0)$, equate
\begin{align}
	U(0) &= U^{\text{old}}(0)  + \frac{\log M(0)}{\rho}\\
	\intertext{Solve for $M(0)$}
	M(0) &= \exp \left(\rho(U(0) - U^{\text{old}}(0))\right)
\end{align}

Then the $M(0)$ should be greater than $1$, and it is the inverse of the proportion of consumption the would be willing to give up to change regimes.




\section{Computation of equilibrium $\Omega(t)$ and $E(t)$}
First, note that $\Omega(t)$ is defined by the solution of the differential equation $	\D[t] \Omega(t) = \left(E(t) - \delta \right)\Omega(t)$ from \cref{eq:E-defined-by-Omega} with boundary conditions of $\Omega(0) = \Omega_0$ and $\Omega(T) = \Omega_T$ where $\Omega_0$ and $\Omega_T$ are the stationary solutions for $\Omega(t)$ at $t = 0$ and $t = T$ respectively. Hence, it suffices to find the equilibrium $E(t)$. On the other hand, note that in steady-state we must have $E(t) = \delta$. Thus, the search space for $E(t)$ is a differentiable $E(t)$ such that $E(T) = \delta$. In actual computation, we use cubic splines with nodes that are uniformly distributed across $[0,T]$.

To find the equilibrium $E(t)$, we first find $\widehat E(t)$ with an arbitrary endpoint on $[0,T]$ and rescale $\widehat E(t)$ by $M$
\begin{align}\label{eq:E-normalized-defn}
	M \widehat E(t) = E(t) - \delta
\end{align}
such that $M \widehat E(T) = \delta$. Substituting \cref{eq:E-normalized-defn} in \cref{eq:E-defined-by-Omega}, we have
\begin{align}
\D[t] \Omega(t) = M \widehat{E}(t) \Omega(t)
\end{align}
solving for $\Omega(t)$, we have
\begin{align}
\Omega_T = \Omega_0 \exp \left(M \int_0^T \widehat{E}(t) dt\right)
\end{align}
which yields
\begin{align}
M = \log \left(\dfrac{\Omega_T}{\Omega_0}\right)\left(\int_0^T \widehat E(t) dt \right)^{-1}
\end{align}
providing the analytic solution for $E(t)$ and $\Omega(t)$ given $\widehat{E} (t)$ with arbitrary endpoints.


\end{document}
